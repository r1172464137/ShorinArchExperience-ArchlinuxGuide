#!/bin/bash
# ClipSync v3.5 - Binary Safe (Fixes QQ Freeze & Null Byte Warnings)
# Author: Shorin | License: MIT

# ================= é…ç½® =================
DEBOUNCE_TIME=0.5
TIMEOUT_TEXT="1s"
TIMEOUT_IMG="4s"
BUF_FILE="/dev/shm/clipsync_buf_$$"
DEBUG=false

# ================= ä¾èµ–æ£€æŸ¥ =================
check_deps() {
    local deps=(xclip wl-copy wl-paste clipnotify md5sum grep)
    for cmd in "${deps[@]}"; do
        if ! command -v "$cmd" &>/dev/null; then
            echo "âŒ Error: Missing dependency: '$cmd'" >&2
            exit 1
        fi
    done
}

# ================= æ—¥å¿—å‡½æ•° =================
log() {
    if $DEBUG; then echo -e "[$(date +'%H:%M:%S')] $*"; fi
}

# ================= æ™ºèƒ½ MIME æ£€æµ‹ =================
detect_best_mime() {
    local raw_types="$1"
    # ä¼˜å…ˆæ£€æµ‹æ–‡ä»¶åˆ—è¡¨
    if [[ "$raw_types" == *"text/uri-list"* ]]; then echo "text/uri-list"; return; fi
    if [[ "$raw_types" == *"text/x-moz-url"* ]]; then echo "text/uri-list"; return; fi
    
    # å›¾ç‰‡ä¼˜å…ˆçº§
    if [[ "$raw_types" == *"image/gif"* ]]; then echo "image/gif"; return; fi
    if [[ "$raw_types" == *"image/png"* ]]; then echo "image/png"; return; fi
    if [[ "$raw_types" == *"image/jpeg"* ]]; then echo "image/jpeg"; return; fi
    
    # æ–‡æœ¬æœ€åŽ
    if [[ "$raw_types" == *"UTF8_STRING"* || "$raw_types" == *"text/plain"* || "$raw_types" == *"STRING"* ]]; then echo "text/plain"; return; fi
}

# ================= è·¯å¾„å‡çº§é€»è¾‘ (å®‰å…¨ç‰ˆ) =================
# ä¿®å¤æ ¸å¿ƒï¼šé¿å…è¯»å–äºŒè¿›åˆ¶æ•°æ®å¯¼è‡´ Bash æŠ¥é”™å’Œ QQ å¡æ­»
promote_path_if_needed() {
    local mime="$1"
    local buf_file="$2"
    
    # åªå¤„ç†çº¯æ–‡æœ¬
    if [[ "$mime" != "text/plain" ]]; then echo "$mime"; return; fi
    
    # ã€å®‰å…¨æ£€æŸ¥ 1ã€‘å¦‚æžœæ–‡ä»¶ä¸ºç©ºï¼Œç›´æŽ¥è¿”å›ž
    if [[ ! -s "$buf_file" ]]; then echo "$mime"; return; fi

    # ã€å®‰å…¨æ£€æŸ¥ 2ã€‘å¿«é€Ÿæ£€æµ‹æ˜¯å¦åŒ…å« Null å­—èŠ‚ (äºŒè¿›åˆ¶æ•°æ®)
    # å¦‚æžœ grep å‘çŽ° null byteï¼Œè¯´æ˜Žè¿™æ ¹æœ¬ä¸æ˜¯è·¯å¾„ï¼Œç›´æŽ¥è·³è¿‡ï¼Œé˜²æ­¢å¡æ­»
    if grep -qP '\x00' "$buf_file" 2>/dev/null; then 
        log "âš ï¸ Binary detected in text/plain, skipping path check."
        echo "$mime"
        return
    fi
    
    # ã€æ€§èƒ½ä¼˜åŒ–ã€‘åªè¯»å–å‰ 1024 ä¸ªå­—èŠ‚ï¼Œé¿å…åŠ è½½æ•´ä¸ªå¤§æ–‡ä»¶
    local content
    content=$(head -c 1024 "$buf_file" | sed 's/^[ \t]*//;s/[ \t]*$//')
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºç»å¯¹è·¯å¾„ä¸”æ–‡ä»¶å­˜åœ¨
    # æ³¨æ„ï¼šåªæ£€æŸ¥ç¬¬ä¸€è¡Œï¼Œé˜²æ­¢å¤šè¡Œæ–‡æœ¬è¢«è¯¯åˆ¤
    local first_line="${content%%$'\n'*}"
    
    if [[ "$first_line" == /* ]] && [[ -e "$first_line" ]]; then
        log "âœ¨ Smart Promote: Text path -> File object"
        # è¦†å†™ç¼“å†²åŒºä¸º file:// æ ¼å¼
        echo "file://$first_line" > "$buf_file"
        echo "text/uri-list" # è¿”å›žæ–°ç±»åž‹
        return
    fi
    
    echo "$mime" # ä¿æŒåŽŸæ ·
}

# ================= å“ˆå¸Œè®¡ç®— =================
calc_hash_cmd() {
    local mime="$1"
    timeout "$TIMEOUT_TEXT" wl-paste --type "$mime" 2>/dev/null | md5sum | cut -d' ' -f1
}

# ================= æ ¸å¿ƒé€»è¾‘ï¼šX11 -> Wayland =================
sync_x2w() {
    local last_hash=""

    while clipnotify; do
        sleep "$DEBOUNCE_TIME"
        
        # 1. èŽ·å– Targets
        local targets
        targets=$(timeout "$TIMEOUT_TEXT" xclip -selection clipboard -t TARGETS -o 2>/dev/null)
        
        local mime
        mime=$(detect_best_mime "$targets")
        [[ -z "$mime" ]] && continue
        
        log "X11 Event. Best: $mime"
        
        # 2. è¯»å–å†…å®¹åˆ°ç¼“å†²åŒº
        local current_timeout="$TIMEOUT_TEXT"
        [[ "$mime" == image/* ]] && current_timeout="$TIMEOUT_IMG"
        
        timeout "$current_timeout" xclip -selection clipboard -t "$mime" -o > "$BUF_FILE" 2>/dev/null
        
        # GIF é™çº§ç­–ç•¥
        if [[ ! -s "$BUF_FILE" ]] && [[ "$mime" == "image/gif" ]] && [[ "$targets" == *"image/png"* ]]; then
            log "âš ï¸ GIF fallback -> PNG"
            mime="image/png"
            timeout "$TIMEOUT_IMG" xclip -selection clipboard -t "$mime" -o > "$BUF_FILE" 2>/dev/null
        fi

        if [[ ! -s "$BUF_FILE" ]]; then continue; fi

        # 3. æ™ºèƒ½è·¯å¾„å‡çº§ (çŽ°åœ¨æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„)
        mime=$(promote_path_if_needed "$mime" "$BUF_FILE")

        # 4. è®¡ç®—å“ˆå¸Œ
        local x_hash
        x_hash=$(md5sum "$BUF_FILE" | cut -d' ' -f1)
        
        if [[ "$x_hash" == "$last_hash" ]]; then continue; fi
        
        # 5. é˜²å›žçŽ¯
        local w_hash
        w_hash=$(calc_hash_cmd "$mime")
        
        if [[ "$x_hash" != "$w_hash" ]]; then
            log "Syncing X -> W ($mime)..."
            if [[ "$mime" == "text/uri-list" ]]; then
                grep -v '^$' "$BUF_FILE" | wl-copy --type "text/uri-list"
            else
                cat "$BUF_FILE" | wl-copy --type "$mime"
            fi
        fi
        
        last_hash="$x_hash"
    done
}

# ================= æ ¸å¿ƒé€»è¾‘ï¼šWayland -> X11 =================
sync_w2x() {
    _handle_change() {
        # 1. æŽ¢æµ‹
        local types
        types=$(wl-paste --list-types 2>/dev/null)
        
        local mime
        mime=$(detect_best_mime "$types")
        [[ -z "$mime" ]] && return

        log "Wayland Event. Type: $mime"

        # 2. Wayland æŒ‡çº¹
        local w_hash
        w_hash=$(calc_hash_cmd "$mime")
        [[ -z "$w_hash" ]] && return

        # 3. X11 æŒ‡çº¹ (é˜²å›žçŽ¯)
        local x_cmd_timeout="$TIMEOUT_TEXT"
        [[ "$mime" == image/* ]] && x_cmd_timeout="$TIMEOUT_IMG"
        
        local x_hash
        x_hash=$(timeout "$x_cmd_timeout" xclip -selection clipboard -t "$mime" -o 2>/dev/null | md5sum | cut -d' ' -f1)
        
        if [[ -n "$x_hash" ]] && [[ "$w_hash" != "$x_hash" ]]; then
            log "Syncing W -> X ($mime)..."
            if [[ "$mime" == "text/uri-list" ]]; then
                wl-paste --type text/uri-list | grep -v '^$' | xclip -selection clipboard -t text/uri-list
            else
                wl-paste --type "$mime" | xclip -selection clipboard -t "$mime"
            fi
        elif [[ -z "$x_hash" ]]; then
            log "X11 empty/busy, enforcing write..."
            if [[ "$mime" == "text/uri-list" ]]; then
                 wl-paste --type text/uri-list | grep -v '^$' | xclip -selection clipboard -t text/uri-list
            else
                 wl-paste --type "$mime" | xclip -selection clipboard -t "$mime"
            fi
        fi
    }

    export TIMEOUT_TEXT="1s" TIMEOUT_IMG="4s" DEBUG
    export -f _handle_change calc_hash_cmd detect_best_mime log promote_path_if_needed
    
    wl-paste --watch bash -c "_handle_change"
}

# ================= ä¸»ç¨‹åº =================
check_deps
echo "ðŸ”„ ClipSync v3.5 (Binary Safe) started..."

touch "$BUF_FILE"

sync_x2w &
PID_X2W=$!

sync_w2x &
PID_W2X=$!

cleanup() {
    echo "ðŸ›‘ Stopping ClipSync..."
    kill "$PID_X2W" 2>/dev/null
    kill "$PID_W2X" 2>/dev/null
    rm -f "$BUF_FILE"
    exit 0
}

trap cleanup SIGINT SIGTERM EXIT
wait
