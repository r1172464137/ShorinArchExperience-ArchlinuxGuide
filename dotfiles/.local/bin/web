#!/bin/bash

# ==============================================================================
# web - æžç®€ç½‘ç»œæœç´¢å·¥å…· (v3.3 äº¤äº’ä¼˜åŒ–ç‰ˆ)
# ==============================================================================
# ä¾èµ–: firefox, fuzzel
# ==============================================================================

CACHE_FILE="$HOME/.cache/web_search_engine"
BROWSER="firefox"

# --- 1. å®šä¹‰æœç´¢å¼•æ“Ž & æè¿° ---
declare -A ENGINES
declare -A DESCRIPTIONS

# å®šä¹‰ URL æ¨¡æ¿
ENGINES=(
    ["google"]="https://www.google.com/search?q=%s"
    ["bing"]="https://www.bing.com/search?q=%s"
    ["duck"]="https://duckduckgo.com/?q=%s"
    ["b"]="https://search.bilibili.com/all?keyword=%s"
    ["gh"]="https://github.com/search?q=%s"
    ["w"]="https://wiki.archlinux.org/index.php?search=%s"
    ["aur"]="https://aur.archlinux.org/packages?K=%s"
    ["yt"]="https://www.youtube.com/results?search_query=%s"
)

# å®šä¹‰æè¿° (ç”¨äºŽèœå•æ˜¾ç¤º)
DESCRIPTIONS=(
    ["google"]="Google Search"
    ["bing"]="Bing Search"
    ["duck"]="DuckDuckGo"
    ["b"]="Bilibili"
    ["gh"]="GitHub"
    ["w"]="Arch Wiki"
    ["aur"]="Arch User Repository"
    ["yt"]="YouTube"
)

# é»˜è®¤å¼•æ“Ž
DEFAULT_ENGINE_KEY="google"

# --- 2. è¾…åŠ©å‡½æ•° ---

get_current_engine_key() {
    if [ -f "$CACHE_FILE" ]; then
        cat "$CACHE_FILE"
    else
        echo "$DEFAULT_ENGINE_KEY"
    fi
}

set_default_engine() {
    # æž„é€ åˆ—è¡¨ï¼šDescription (key)
    # ä½¿ç”¨ç®¡é“ç›´æŽ¥ä¼ è¾“ï¼Œé¿å…ç©ºè¡Œé—®é¢˜
    # --lines 8: è®¾ç½®èœå•é€‰é¡¹è¾ƒå¤šï¼Œä¿æŒè¶³å¤Ÿé«˜åº¦
    SELECTED_LINE=$(
        for key in "${!ENGINES[@]}"; do
            printf "%s (%s)\n" "${DESCRIPTIONS[$key]}" "$key"
        done | sort | fuzzel -d -p "Set Engine âš™ï¸ : " --width 40 --lines 8
    )
    
    if [ -n "$SELECTED_LINE" ]; then
        # æå–æ‹¬å·é‡Œçš„ key
        SELECTED_KEY=$(echo "$SELECTED_LINE" | sed -n 's/.*(\(.*\))$/\1/p')
        
        if [[ -n "${ENGINES[$SELECTED_KEY]}" ]]; then
            mkdir -p "$(dirname "$CACHE_FILE")"
            echo "$SELECTED_KEY" > "$CACHE_FILE"
        fi
    fi
}

show_help() {
    echo "Usage: web [QUERY]"
    echo "Type 'Settings' in the menu to change default engine."
}

# --- 3. ä¸»é€»è¾‘ ---

case "$1" in
    -h|--help) show_help; exit 0 ;;
    -s|--set)  set_default_engine; exit 0 ;;
esac

# èŽ·å–è¾“å…¥
if [ -n "$1" ]; then
    QUERY="$*"
else
    CURRENT_ENG_KEY=$(get_current_engine_key)
    CURRENT_ENG_NAME="${DESCRIPTIONS[$CURRENT_ENG_KEY]}"
    
    MENU_ITEM="âš™ï¸  Change Engine"
    
    # ä¼˜åŒ–ç‚¹ 1: æç¤ºç¬¦ä¸å†é‡å¤ "Search"ï¼Œç›´æŽ¥æ˜¾ç¤ºå¼•æ“Žåï¼Œä¾‹å¦‚ "Google Search ðŸ” :"
    # ä¼˜åŒ–ç‚¹ 2: --lines 1ï¼Œåˆå§‹ç•Œé¢å˜ç´§å‡‘ï¼Œåªæ˜¾ç¤ºè¾“å…¥è¡Œå’Œèœå•é¡¹
    QUERY=$(echo -e "$MENU_ITEM" | fuzzel -d -p "$CURRENT_ENG_NAME ðŸ” : " --lines 1 --width 50)
fi

if [ -z "$QUERY" ]; then exit 0; fi

# --- 4. æ‹¦æˆªè®¾ç½®å‘½ä»¤ ---
if [[ "$QUERY" == *"Change Engine"* ]]; then
    set_default_engine
    
    # ä¼˜åŒ–ç‚¹ 3: è®¾ç½®å®ŒæˆåŽï¼Œé‡æ–°æ‰§è¡Œè„šæœ¬è‡ªèº« (exec "$0")
    # è¿™æ ·ç”¨æˆ·ä¼šç›´æŽ¥å›žåˆ°æœç´¢æ¡†ï¼Œä¸”å¼•æ“Žå·²ç»æ›´æ–°
    exec "$0"
fi

# --- 5. æœç´¢é€»è¾‘ ---

KEYWORD=$(echo "$QUERY" | awk '{print $1}')

if [[ -n "${ENGINES[$KEYWORD]}" ]]; then
    URL_TEMPLATE="${ENGINES[$KEYWORD]}"
    REST_QUERY=$(echo "$QUERY" | cut -d' ' -f2-)
else
    DEFAULT_KEY=$(get_current_engine_key)
    if [[ -z "${ENGINES[$DEFAULT_KEY]}" ]]; then DEFAULT_KEY="google"; fi
    URL_TEMPLATE="${ENGINES[$DEFAULT_KEY]}"
    REST_QUERY="$QUERY"
fi

ENCODED_QUERY="${REST_QUERY// /%20}"
FINAL_URL="${URL_TEMPLATE/\%s/$ENCODED_QUERY}"

nohup "$BROWSER" --new-tab "$FINAL_URL" >/dev/null 2>&1 &
