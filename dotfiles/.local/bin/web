#!/bin/bash

# ==============================================================================
# web - ç½‘ç»œæžé€Ÿå¯åŠ¨å™¨ (v4.0 Final)
# ==============================================================================
# ä¾èµ–: firefox, fuzzel
# ==============================================================================

CACHE_FILE="$HOME/.cache/web_search_engine"
BROWSER="firefox"

# --- 1. å®šä¹‰å¼•æ“Ž & ä¹¦ç­¾ ---
declare -A ENGINES
declare -A DESCRIPTIONS

# [æ ¸å¿ƒé€»è¾‘]
# å¸¦æœ‰ %s çš„æ˜¯æœç´¢å¼•æ“Ž
# ä¸å¸¦ %s çš„æ˜¯å¿«é€Ÿä¹¦ç­¾ (Quick Link)
ENGINES=(
    ["google"]="https://www.google.com/search?q=%s"
    ["bing"]="https://www.bing.com/search?q=%s"
    ["b"]="https://search.bilibili.com/all?keyword=%s"
    ["gh"]="https://github.com/search?q=%s"
    ["w"]="https://wiki.archlinux.org/index.php?search=%s"
    ["aur"]="https://aur.archlinux.org/packages?K=%s"
    ["yt"]="https://www.youtube.com/results?search_query=%s"
    
    # === çº¯ä¹¦ç­¾åŒº ===
    ["gemini"]="https://gemini.google.com/app"
    ["gpt"]="https://chatgpt.com/"
    ["red"]="https://www.reddit.com/"
)

# èœå•æè¿°
DESCRIPTIONS=(
    ["google"]="Google Search"
    ["bing"]="Bing Search"
    ["b"]="Bilibili"
    ["gh"]="GitHub"
    ["w"]="Arch Wiki"
    ["aur"]="AUR"
    ["yt"]="YouTube"
    ["gemini"]="Gemini AI"
    ["gpt"]="ChatGPT"
    ["red"]="Reddit"
)

# é»˜è®¤å¼•æ“Ž
DEFAULT_ENGINE_KEY="google"

# --- 2. è¾…åŠ©å‡½æ•° ---

get_current_engine_key() {
    if [ -f "$CACHE_FILE" ]; then cat "$CACHE_FILE"; else echo "$DEFAULT_ENGINE_KEY"; fi
}

set_default_engine() {
    SELECTED_LINE=$(
        for key in "${!ENGINES[@]}"; do
            printf "%s (%s)\n" "${DESCRIPTIONS[$key]}" "$key"
        done | sort | fuzzel -d -p "Set Engine âš™ï¸ : " --width 40 --lines 10
    )
    if [ -n "$SELECTED_LINE" ]; then
        SELECTED_KEY=$(echo "$SELECTED_LINE" | sed -n 's/.*(\(.*\))$/\1/p')
        if [[ -n "${ENGINES[$SELECTED_KEY]}" ]]; then
            mkdir -p "$(dirname "$CACHE_FILE")"
            echo "$SELECTED_KEY" > "$CACHE_FILE"
        fi
    fi
}

# --- 3. ä¸»é€»è¾‘ ---

case "$1" in
    -h|--help) echo "Usage: web [QUERY]"; exit 0 ;;
    -s|--set)  set_default_engine; exit 0 ;;
esac

if [ -n "$1" ]; then
    QUERY="$*"
else
    CURRENT_ENG_KEY=$(get_current_engine_key)
    # æç¤ºç¬¦æ˜¾ç¤ºå½“å‰é»˜è®¤å¼•æ“Ž
    QUERY=$(echo -e "âš™ï¸  Change Engine" | fuzzel -d -p "${DESCRIPTIONS[$CURRENT_ENG_KEY]} ðŸ” : " --lines 1 --width 50)
fi

if [ -z "$QUERY" ]; then exit 0; fi

# æ‹¦æˆªè®¾ç½®
if [[ "$QUERY" == *"Change Engine"* ]]; then
    set_default_engine
    exec "$0"
fi

# --- 4. æ™ºèƒ½è·¯ç”± ---

KEYWORD=$(echo "$QUERY" | awk '{print $1}')

if [[ -n "${ENGINES[$KEYWORD]}" ]]; then
    # å‘½ä¸­å‰ç¼€ (ä¾‹å¦‚è¾“å…¥äº† "gemini" æˆ– "gemini hello")
    URL_TEMPLATE="${ENGINES[$KEYWORD]}"
    # æå–å‰©ä½™éƒ¨åˆ† (å¦‚æžœæœ‰çš„è¯)
    REST_QUERY=$(echo "$QUERY" | cut -d' ' -f2-)
else
    # æœªå‘½ä¸­å‰ç¼€ï¼Œä½¿ç”¨é»˜è®¤å¼•æ“Žè¿›è¡Œæœç´¢
    DEFAULT_KEY=$(get_current_engine_key)
    if [[ -z "${ENGINES[$DEFAULT_KEY]}" ]]; then DEFAULT_KEY="google"; fi
    URL_TEMPLATE="${ENGINES[$DEFAULT_KEY]}"
    REST_QUERY="$QUERY"
fi

# --- 5. URL æž„é€  ---
# åªæœ‰å½“ URL é‡ŒåŒ…å« %s æ—¶ï¼Œæ‰æŠŠæŸ¥è¯¢è¯å¡«è¿›åŽ»
# å¦åˆ™ç›´æŽ¥æ‰“å¼€ URL (è¿™å°±æ˜¯ä½ è¦çš„â€œå¿«é€Ÿæ‰“å¼€â€æ•ˆæžœ)

if [[ "$URL_TEMPLATE" == *"%s"* ]]; then
    ENCODED_QUERY="${REST_QUERY// /%20}"
    FINAL_URL="${URL_TEMPLATE/\%s/$ENCODED_QUERY}"
else
    # çº¯é“¾æŽ¥æ¨¡å¼ï¼šå¿½ç•¥åŽé¢çš„ä¹±ä¸ƒå…«ç³Ÿè¾“å…¥ï¼Œç›´æŽ¥è·³é¦–é¡µ
    FINAL_URL="$URL_TEMPLATE"
fi

nohup "$BROWSER" --new-tab "$FINAL_URL" >/dev/null 2>&1 &
