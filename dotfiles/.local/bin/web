#!/bin/bash

# ==============================================================================
# web - ç½‘ç»œæžé€Ÿå¯åŠ¨å™¨ (v5.0 History Edition)
# ==============================================================================
# ä¾èµ–: firefox, fuzzel
# ==============================================================================

CACHE_FILE="$HOME/.cache/web_search_engine"
HISTORY_FILE="$HOME/.cache/web_search_history"
BROWSER="firefox"
MAX_HISTORY=50

# --- 1. å®šä¹‰å¼•æ“Ž & ä¹¦ç­¾ ---
declare -A ENGINES
declare -A DESCRIPTIONS

ENGINES=(
    ["google"]="https://www.google.com/search?q=%s"
    ["bing"]="https://www.bing.com/search?q=%s"
    ["b"]="https://search.bilibili.com/all?keyword=%s"
    ["gh"]="https://github.com/search?q=%s"
    ["w"]="https://wiki.archlinux.org/index.php?search=%s"
    ["aur"]="https://aur.archlinux.org/packages?K=%s"
    ["yt"]="https://www.youtube.com/results?search_query=%s"
    ["gemini"]="https://gemini.google.com/app"
    ["gpt"]="https://chatgpt.com/"
    ["red"]="https://www.reddit.com/"
)

DESCRIPTIONS=(
    ["google"]="Google Search"
    ["bing"]="Bing Search"
    ["b"]="Bilibili"
    ["gh"]="GitHub"
    ["w"]="Arch Wiki"
    ["aur"]="AUR"
    ["yt"]="YouTube"
    ["gemini"]="Gemini AI"
    ["gpt"]="ChatGPT"
    ["red"]="Reddit"
)

DEFAULT_ENGINE_KEY="google"

# --- 2. è¾…åŠ©å‡½æ•° ---

get_current_engine_key() {
    if [ -f "$CACHE_FILE" ]; then cat "$CACHE_FILE"; else echo "$DEFAULT_ENGINE_KEY"; fi
}

# æ›´æ–°åŽ†å²è®°å½• (åŽ»é‡ + ç§»åŠ¨åˆ°æœ«å°¾)
update_history() {
    local input="$1"
    # å¦‚æžœè¾“å…¥ä¸ºç©ºæˆ–æ˜¯è®¾ç½®å‘½ä»¤ï¼Œä¸è®°å½•
    if [[ -z "$input" || "$input" == *"Change Engine"* ]]; then return; fi

    # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
    touch "$HISTORY_FILE"

    # 1. åˆ é™¤æ—§çš„ç›¸åŒè®°å½• (grep -vFx: ç²¾ç¡®åŒ¹é…æ•´è¡Œå¹¶åé€‰)
    # 2. è¿½åŠ æ–°è®°å½•åˆ°æœ«å°¾
    # 3. åªä¿ç•™æœ€åŽ MAX_HISTORY è¡Œ
    grep -vFx "$input" "$HISTORY_FILE" > "${HISTORY_FILE}.tmp"
    echo "$input" >> "${HISTORY_FILE}.tmp"
    tail -n "$MAX_HISTORY" "${HISTORY_FILE}.tmp" > "$HISTORY_FILE"
    rm "${HISTORY_FILE}.tmp"
}

set_default_engine() {
    SELECTED_LINE=$(
        for key in "${!ENGINES[@]}"; do
            printf "%s (%s)\n" "${DESCRIPTIONS[$key]}" "$key"
        done | sort | fuzzel -d -p "Set Engine âš™ï¸ : " --width 40 --lines 10
    )
    if [ -n "$SELECTED_LINE" ]; then
        SELECTED_KEY=$(echo "$SELECTED_LINE" | sed -n 's/.*(\(.*\))$/\1/p')
        if [[ -n "${ENGINES[$SELECTED_KEY]}" ]]; then
            mkdir -p "$(dirname "$CACHE_FILE")"
            echo "$SELECTED_KEY" > "$CACHE_FILE"
        fi
    fi
}

# --- 3. ä¸»é€»è¾‘ ---

case "$1" in
    -h|--help) echo "Usage: web [QUERY]"; exit 0 ;;
    -s|--set)  set_default_engine; exit 0 ;;
esac

if [ -n "$1" ]; then
    QUERY="$*"
else
    CURRENT_ENG_KEY=$(get_current_engine_key)
    MENU_ITEM="âš™ï¸  Change Engine"
    
    # [æ ¸å¿ƒä¿®æ”¹] è¯»å–åŽ†å²è®°å½•
    # tac: åå‘è¯»å–æ–‡ä»¶ (æœ€æ–°çš„åœ¨æœ€ä¸‹é¢ï¼Œåå‘åŽå˜æˆæœ€ä¸Šé¢)
    HISTORY_LIST=""
    if [ -f "$HISTORY_FILE" ]; then
        HISTORY_LIST=$(tac "$HISTORY_FILE")
    fi

    # æ‹¼æŽ¥èœå•: è®¾ç½®é€‰é¡¹ + åŽ†å²è®°å½•
    # --lines 10: ç¨å¾®åŠ é«˜ä¸€ç‚¹ï¼Œæ–¹ä¾¿çœ‹åŽ†å²
    QUERY=$(echo -e "$MENU_ITEM\n$HISTORY_LIST" | fuzzel -d -p "${DESCRIPTIONS[$CURRENT_ENG_KEY]} ðŸ” : " --lines 10 --width 50)
fi

if [ -z "$QUERY" ]; then exit 0; fi

# æ‹¦æˆªè®¾ç½®
if [[ "$QUERY" == *"Change Engine"* ]]; then
    set_default_engine
    exec "$0"
fi

# --- 4. è®°å½•åŽ†å² ---
# åœ¨æ‰§è¡Œæœç´¢å‰ï¼Œå…ˆæŠŠè¿™æ¬¡çš„ QUERY å­˜è¿›åŽ»
update_history "$QUERY"

# --- 5. æ™ºèƒ½è·¯ç”± ---

KEYWORD=$(echo "$QUERY" | awk '{print $1}')

if [[ -n "${ENGINES[$KEYWORD]}" ]]; then
    URL_TEMPLATE="${ENGINES[$KEYWORD]}"
    REST_QUERY=$(echo "$QUERY" | cut -d' ' -f2-)
else
    DEFAULT_KEY=$(get_current_engine_key)
    if [[ -z "${ENGINES[$DEFAULT_KEY]}" ]]; then DEFAULT_KEY="google"; fi
    URL_TEMPLATE="${ENGINES[$DEFAULT_KEY]}"
    REST_QUERY="$QUERY"
fi

# --- 6. URL æž„é€ ä¸Žå¯åŠ¨ ---

if [[ "$URL_TEMPLATE" == *"%s"* ]]; then
    ENCODED_QUERY="${REST_QUERY// /%20}"
    FINAL_URL="${URL_TEMPLATE/\%s/$ENCODED_QUERY}"
else
    FINAL_URL="$URL_TEMPLATE"
fi

nohup "$BROWSER" --new-tab "$FINAL_URL" >/dev/null 2>&1 &
