#!/bin/bash

# ==============================================================================
# pacr - Fuzzy find and remove packages (Localized & Non-blocking)
# ==============================================================================
# tset
set -o pipefail

# --- 1. Pre-Configuration ---
ORIGINAL_LANG="${LC_ALL:-${LC_MESSAGES:-${LANG}}}"
SHOW_HELP=false
QUERY_ARGS=""

# --- 2. Argument Parsing ---
while [[ $# -gt 0 ]]; do
    case "$1" in
        --help|-h)
            SHOW_HELP=true
            shift
            ;;
        *)
            # Collect search terms
            QUERY_ARGS="$QUERY_ARGS $1"
            shift
            ;;
    esac
done
# Trim leading space
QUERY_ARGS="${QUERY_ARGS# }"

# --- 3. Auto-Detect Language ---
if [[ "$ORIGINAL_LANG" == *"zh_CN"* ]]; then
    UI_LANG="zh"
else
    UI_LANG="en"
fi

# --- 4. Environment Setup ---
export LC_ALL=C

# --- 5. Colors ---
COLOR_OFF='\033[34m'
COLOR_AUR='\033[35m'
COLOR_RESET='\033[0m'

# --- 6. Localization Table ---
LANG_TABLE='
MSG_USAGE_DESC    | Fuzzy search & remove installed packages.                  | 模糊搜索并卸载已安装的软件包。
MSG_USAGE_FEAT    | Features:                                                  | 功能特性：
MSG_FEAT_1        | - Clean Remove: Recursive w/ configs (-Rns)                | - 彻底卸载：递归删除依赖和配置 (-Rns)
MSG_FEAT_2        | - Visuals: Blue(Native) Purple(AUR)                        | - 视觉区分：蓝色(官方源) 紫色(AUR)
MSG_FEAT_3        | - Batch: Tab to select multiple                            | - 批量操作：Tab 多选，Enter 卸载
MSG_USAGE_EX      | Example:                                                   | 示例：
MSG_ERR_FZF       | Error: fzf not found.                                      | 错误：未找到 fzf。
MSG_ERR_YAY       | Error: yay not found.                                      | 错误：未找到 yay。
MSG_REMOVING      | >> Preparing to remove:                                    | >> 准备卸载：
FZF_HEADER        | Tab:Multi-Select | Enter:Remove | Esc:Exit                 | Tab:多选 | Enter:卸载 | Esc:退出
'

while IFS='|' read -r v e c; do
    v=$(printf '%s' "$v" | sed 's/^ *//;s/ *$//')
    e=$(printf '%s' "$e" | sed 's/^ *//;s/ *$//')
    c=$(printf '%s' "$c" | sed 's/^ *//;s/ *$//')
    [ -z "$v" ] && continue
    case "$v" in \#*) continue ;; esac
    
    if [ "$UI_LANG" = "zh" ]; then
        eval "$v=\"$c\""
    else
        eval "$v=\"$e\""
    fi
done <<EOF
$LANG_TABLE
EOF

# --- 7. Help Function ---
if [ "$SHOW_HELP" = true ]; then
    cat <<EOF
Usage: pacr [options] [query]

Options:
  --help, -h    Show this help and exit

Description:
  $MSG_USAGE_DESC

$MSG_USAGE_FEAT
  $MSG_FEAT_1
  $MSG_FEAT_2
  $MSG_FEAT_3

$MSG_USAGE_EX
  pacr firefox       # Search and remove 'firefox'
  pacr               # List all installed packages
EOF
    exit 0
fi

# --- 8. Dependency Check ---
command -v fzf >/dev/null 2>&1 || { echo "$MSG_ERR_FZF" >&2; exit 1; }
command -v yay >/dev/null 2>&1 || { echo "$MSG_ERR_YAY" >&2; exit 1; }

# --- 9. Async Logic Setup ---

PREVIEW_CMD='yay -Qi {2}'

# Temp files & FIFO
TARGET_FILE=$(mktemp -t pacr_fzf.XXXXXX)
PIPE_FIFO=$(mktemp -u)
mkfifo "$PIPE_FIFO"

# Cleanup trap (Kill background process on exit)
cleanup() {
    if [ -n "$PID_GEN" ]; then kill "$PID_GEN" 2>/dev/null; fi
    rm -f "$TARGET_FILE" "$PIPE_FIFO"
}
trap cleanup EXIT INT TERM

# --- 10. Data Generation (Background) ---
# Use subshell to run data collection in background
(
    # 1. Native Packages (Blue)
    pacman -Qn | awk -v c="$COLOR_OFF" -v r="$COLOR_RESET" \
        '{printf "%s%-10s%s %-30s %s\n", c, "local", r, $1, $2}'

    # 2. Foreign/AUR Packages (Purple)
    pacman -Qm | awk -v c="$COLOR_AUR" -v r="$COLOR_RESET" \
        '{printf "%s%-10s%s %-30s %s\n", c, "aur", r, $1, $2}'

) > "$PIPE_FIFO" 2>/dev/null &

PID_GEN=$!

# --- 11. Interactive FZF ---
fzf --multi --ansi \
    --preview "$PREVIEW_CMD" \
    --preview-window=right:60%:wrap \
    --height=95% --layout=reverse --border \
    --tiebreak=index \
    --nth=2 \
    --header "$FZF_HEADER" \
    --query "$QUERY_ARGS" \
    < "$PIPE_FIFO" \
    > "$TARGET_FILE"

# --- 12. Execution ---
if [ -s "$TARGET_FILE" ]; then
    # Extract only the package name (column 2)
    PACKAGES=$(awk '{print $2}' "$TARGET_FILE" | tr '\n' ' ')
    
    if [ -n "$PACKAGES" ]; then
        echo -e "\n${COLOR_OFF}${MSG_REMOVING}${COLOR_RESET}"
        echo "$PACKAGES"
        echo "----------------------------------------"
        # -Rns: Recursive remove + configs + unused dependencies
        yay -Rns $PACKAGES
    fi
fi
