#!/bin/bash

# ===============================================================
# Arch Linux System Cleanup Assistant (Best Version)
# ===============================================================
# 【功能说明】
# 1. 移除孤儿软件包 (Orphans)
# 2. 清理 Pacman 软件包缓存 (保留安装包，删除旧版本)
# 3. 清理残留的下载目录 (download-*)
# 4. 清理 Systemd 日志 (只保留最近 2 周)
# 5. 清空用户回收站 (Trash) 和缩略图缓存 (Thumbnails)
# 6. 移除未使用的 Flatpak 运行时
# ===============================================================

set -euo pipefail

# ------------------------------
# 1. Default parameters
# ------------------------------
SKIP_CONFIRM=false
# 智能语言检测
UI_LANG=$(locale 2>/dev/null | awk -F= '/^LC_MESSAGES=/{print $2}' | grep -q zh_CN && echo zh || echo en)

# ------------------------------
# 2. Argument parsing
# ------------------------------
usage() {
    cat <<EOF
Usage: $(basename "$0") [options]

Options:
  --ui-lang zh|en    Force UI language (default: auto)
  --yes, -y          Skip confirmation prompt (non-interactive)
  --help, -h         Show this help and exit
EOF
}

while [[ $# -gt 0 ]]; do
    case "$1" in
        --ui-lang)
            [[ "$2" =~ ^(zh|en)$ ]] && UI_LANG="$2" shift 2 || { echo "Error: --ui-lang requires zh or en."; exit 1; }
            ;;
        --yes|-y)
            SKIP_CONFIRM=true
            shift
            ;;
        --help|-h)
            usage; exit 0
            ;;
        *)
            echo "Unknown option: $1"; usage; exit 1
            ;;
    esac
done

# ------------------------------
# 3. Localization Logic
# ------------------------------
LANG_TABLE='
TAG_INFO         | [INFO]                                          | [消息]
TAG_SUCCESS      | [OK]                                            | [成功]
TAG_WARN         | [WARN]                                          | [注意]
TAG_ERROR        | [ERROR]                                         | [错误]

INTRO_HEADER     | === Arch Linux System Cleanup Assistant ===     | === Arch Linux 系统清理助手 ===
MSG_DESC_TITLE   | The script will perform the following tasks:    | 本脚本将执行以下清理操作：
MSG_DESC_1       | 1. Remove orphaned packages                     | 1. 删除孤儿软件包 (不再被需要的依赖)
MSG_DESC_2       | 2. Clean package cache (keep installed)         | 2. 清理软件包缓存 (仅保留已安装版本)
MSG_DESC_3       | 3. Vacuum systemd journal logs (keep 2 weeks)   | 3. 清理 systemd 日志 (保留最近2周)
MSG_DESC_4       | 4. Empty Trash and thumbnail cache              | 4. 清空回收站和缩略图缓存
MSG_DESC_5       | 5. Remove unused Flatpak runtimes               | 5. 删除未使用的 Flatpak 运行时
MSG_ASK_CONFIRM  | Continue with cleanup? [Y/n]                    | 是否继续执行清理？[Y/n]
MSG_ABORT        | Cleanup cancelled by user.                      | 用户已取消清理。
MSG_DONE         | System cleanup completed!                       | 系统清理完成！

MSG_NO_HELPER    | No AUR helper found (paru or yay required).     | 未找到 AUR 助手 (需要 paru 或 yay) 
MSG_HELPER_USE   | Using AUR helper: %s                            | 使用 AUR 助手：%s
MSG_STEP_ORPHAN  | Checking for orphaned packages...               | 正在检查孤儿软件包...
MSG_ORPHAN_FOUND | Orphaned packages detected:                     | 发现孤儿软件包：
MSG_ORPHAN_CLEAN | Orphaned packages removed.                      | 已删除孤儿软件包。
MSG_ORPHAN_NONE  | No orphaned packages found.                     | 未发现孤儿软件包。
MSG_STEP_CACHE   | Cleaning package cache...                       | 正在清理软件包缓存...
MSG_CACHE_DONE   | Package cache cleaned.                          | 软件包缓存已清理。
MSG_STEP_BROKEN  | Cleaning residual download directories...       | 正在清理残留下载目录...
MSG_BROKEN_DONE  | Residual directories removed.                   | 残留目录已清理。
MSG_STEP_LOG     | Vacuuming systemd journal logs...               | 正在清理 systemd 日志...
MSG_LOG_DONE     | Systemd journal logs cleaned.                   | 系统日志已清理。
MSG_STEP_TRASH   | Cleaning user Trash and thumbnails...           | 正在清理回收站和缩略图...
MSG_TRASH_DONE   | Trash emptied.                                  | 回收站已清空。
MSG_THUMB_DONE   | Thumbnails cleaned.                             | 缩略图已清理。
MSG_STEP_FLATPAK | Checking for unused Flatpak runtimes...         | 正在检查未使用的 Flatpak 运行时...
MSG_FLATPAK_DONE | Unused Flatpak runtimes removed.                | 未使用的 Flatpak 运行时已删除。
'

while IFS='|' read -r v e c; do
    v=$(printf "%s" "$v" | sed 's/^ *//;s/ *$//')
    e=$(printf "%s" "$e" | sed 's/^ *//;s/ *$//')
    c=$(printf "%s" "$c" | sed 's/^ *//;s/ *$//')
    [ -z "$v" ] && continue
    case "$v" in \#*) continue ;; esac
    [ "$UI_LANG" = "zh" ] && eval "$v=\"\$c\"" || eval "$v=\"\$e\""
done <<EOF
$LANG_TABLE
EOF

# ------------------------------
# 4. Define Colors & Logging
# ------------------------------
NC='\033[0m'
H_BLUE='\033[1;34m'
H_GREEN='\033[1;32m'
H_YELLOW='\033[1;33m'
H_RED='\033[1;31m'
H_CYAN='\033[1;36m'

_info()    { printf "${H_BLUE}%-10s${NC} %s\n" "${TAG_INFO}" "$1"; }
_success() { printf "${H_GREEN}%-10s${NC} %s\n" "${TAG_SUCCESS}" "$1"; }
_warn()    { printf "${H_YELLOW}%-10s${NC} %s\n" "${TAG_WARN}" "$1"; }
_error()   { printf "${H_RED}%-10s${NC} %s\n" "${TAG_ERROR}" "$1"; exit 1; }

# ------------------------------
# 5. Check Helper
# ------------------------------
if command -v paru &>/dev/null; then AUR_HELPER=paru
elif command -v yay &>/dev/null; then AUR_HELPER=yay
else _error "$MSG_NO_HELPER"; fi

# ------------------------------
# 6. Introduction & Confirmation
# ------------------------------
if [ "$SKIP_CONFIRM" = false ]; then
    printf "\n${H_CYAN}%s${NC}\n" "$INTRO_HEADER"
    printf "%s\n" "$MSG_DESC_TITLE"
    printf "  %s\n" "$MSG_DESC_1"
    printf "  %s\n" "$MSG_DESC_2"
    printf "  %s\n" "$MSG_DESC_3"
    printf "  %s\n" "$MSG_DESC_4"
    printf "  %s\n" "$MSG_DESC_5"
    
    printf "\n${H_YELLOW}%s ${NC}" "$MSG_ASK_CONFIRM"
    read -r confirm
    case "$confirm" in
        [yY][eE][sS]|[yY]|"") ;; # Enter or Yes continues
        *) printf "%s\n" "$MSG_ABORT"; exit 0 ;;
    esac
fi

# ------------------------------
# 7. Execution
# ------------------------------
_info "$(printf "$MSG_HELPER_USE" "$AUR_HELPER")"

# Keep Sudo Alive (Trap method is safest)
if sudo -v; then
    while true; do sudo -n true; sleep 60; done 2>/dev/null &
    SUDO_PID=$!
    trap 'kill $SUDO_PID 2>/dev/null' EXIT
else
    _error "Sudo failed."
fi

# [1] Orphans
_info "$MSG_STEP_ORPHAN"
# pacman -Qtdq returns exit code 1 if no orphans found, so we temporarily allow failure
if ORPHANS=$(pacman -Qtdq || true); then
    if [ -n "$ORPHANS" ]; then
        printf "${H_YELLOW}%s${NC}\n" "$MSG_ORPHAN_FOUND"
        echo "$ORPHANS"
        # xargs -r prevents running if input is empty
        echo "$ORPHANS" | xargs -r $AUR_HELPER -Rns --noconfirm
        _success "$MSG_ORPHAN_CLEAN"
    else
        _success "$MSG_ORPHAN_NONE"
    fi
fi

# [2] Cache
_info "$MSG_STEP_CACHE"
# -Sc removes uninstalled packages from cache
$AUR_HELPER -Sc --noconfirm
_success "$MSG_CACHE_DONE"

# [3] Broken Downloads (var/cache/pacman/pkg/download-*)
TARGET_DIR="/var/cache/pacman/pkg"
if [ -d "$TARGET_DIR" ]; then
    found=0
    # Safe find loop handling spaces in filenames
    while IFS= read -r -d '' dir; do
        if [ "$found" -eq 0 ]; then
            _info "$MSG_STEP_BROKEN"
            found=1
        fi
        sudo rm -rf -- "$dir"
        printf "  Removed: %s\n" "$dir"
    done < <(find "$TARGET_DIR" -maxdepth 1 -type d -name "download-*" -print0 2>/dev/null)
    [ "$found" -eq 1 ] && _success "$MSG_BROKEN_DONE"
fi

# [4] Journal
_info "$MSG_STEP_LOG"
sudo journalctl --vacuum-time=2weeks >/dev/null 2>&1
_success "$MSG_LOG_DONE"

# [5] Trash & Thumbnails
_info "$MSG_STEP_TRASH"
TRASH_DIR="$HOME/.local/share/Trash"
THUMB_DIR="$HOME/.cache/thumbnails"

if [ -d "$TRASH_DIR" ]; then
    # Only delete inside content, not the Trash folder itself
    find "$TRASH_DIR" -mindepth 1 -delete 2>/dev/null || true
    _success "$MSG_TRASH_DONE"
fi

if [ -d "$THUMB_DIR" ]; then
    find "$THUMB_DIR" -type f -atime +30 -delete 2>/dev/null || true
    _success "$MSG_THUMB_DONE"
fi

# [6] Flatpak
if command -v flatpak >/dev/null 2>&1; then
    _info "$MSG_STEP_FLATPAK"
    flatpak uninstall --unused -y >/dev/null 2>&1
    _success "$MSG_FLATPAK_DONE"
fi

printf "\n"
_success "$MSG_DONE"
