#!/bin/bash

# ==============================================================================
# quickload.sh - Emergency System Rollback Tool (Rescue Mode Enabled)
# ==============================================================================
# Usage: 
#   sudo ./quickload.sh             (Defaults to target: "quicksave")
#   sudo ./quickload.sh -d "backup" (Targets snapshot with desc: "backup")
# ==============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default Target
TARGET_DESC="quicksave"

# --- Argument Parsing (-d flag) ---
while getopts ":d:" opt; do
  case $opt in
    d)
      TARGET_DESC="$OPTARG"
      ;;
    \?)
      echo -e "${RED}Invalid option: -$OPTARG${NC}" >&2
      echo "Usage: sudo $0 [-d 'snapshot description']"
      exit 1
      ;;
    :)
      echo -e "${RED}Option -$OPTARG requires an argument.${NC}" >&2
      exit 1
      ;;
  esac
done

# --- String Validation ---
# Trim whitespace and check if empty
if [[ -z "${TARGET_DESC// }" ]]; then
    echo -e "${RED}Error: Target description cannot be empty.${NC}"
    exit 1
fi

TEMP_MOUNT_DIR=$(mktemp -d)

# Cleanup function to ensure unmount happens on exit/error
cleanup() {
    if mountpoint -q "$TEMP_MOUNT_DIR"; then
        echo -e "${BLUE}Cleaning up: Unmounting temporary rescue volume...${NC}"
        umount "$TEMP_MOUNT_DIR"
    fi
    if [ -d "$TEMP_MOUNT_DIR" ]; then
        rm -rf "$TEMP_MOUNT_DIR"
    fi
}
trap cleanup EXIT

# 1. Check Root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: Please run as root${NC}"
    exit 1
fi

# 2. Check Dependencies
for cmd in snapper btrfs-assistant findmnt; do
    if ! command -v $cmd &> /dev/null; then
        echo -e "${RED}Error: $cmd is not installed.${NC}"
        exit 1
    fi
done

echo -e "${YELLOW}>>> Initializing Emergency Rollback...${NC}"
echo -e "    Target Snapshot Description: ${GREEN}'$TARGET_DESC'${NC}"

# --- Function: Rescue Mode ID Lookup ---
get_id_rescue_mode() {
    echo -e "${BLUE}>>> Attempting Rescue Mode Lookup (Mounting Real Root)...${NC}"
    
    local root_dev=$(findmnt -n -o SOURCE /)
    # Strip brackets if present (e.g., /dev/sda1[/subvol])
    root_dev=${root_dev%\[*} 
    
    if [ -z "$root_dev" ]; then
        echo -e "${RED}  [FAIL] Could not identify root device.${NC}"
        return 1
    fi
    
    echo -e "  Detected Root Device: ${GREEN}$root_dev${NC}"

    # Mount Top-Level Subvolume (ID 5)
    if ! mount -t btrfs -o subvolid=5 "$root_dev" "$TEMP_MOUNT_DIR"; then
        echo -e "${RED}  [FAIL] Failed to mount root device for rescue lookup.${NC}"
        return 1
    fi

    local target_path="$TEMP_MOUNT_DIR/@"
    if [ ! -d "$target_path" ]; then
         # Fallback check if user doesn't use @ scheme (less likely on Arch but possible)
         if [ -d "$TEMP_MOUNT_DIR/.snapshots" ]; then
             target_path="$TEMP_MOUNT_DIR"
         else
             echo -e "${RED}  [FAIL] Could not find '@' or '.snapshots' in mounted device.${NC}"
             return 1
         fi
    fi

    echo -e "  Scanning database in: $target_path"
    
    # Use quotes around TARGET_DESC to handle spaces safely
    local found_id=$(snapper --no-dbus --root "$target_path" -c root list --columns number,description | grep "$TARGET_DESC" | tail -n 1 | awk '{print $1}')
    
    if [ -n "$found_id" ]; then
        echo "$found_id"
        return 0
    else
        return 1
    fi
}

# --- Function: Rollback Logic ---
perform_rollback() {
    local subvol="$1"
    local snap_conf="$2"
    
    echo -e "Checking config: ${YELLOW}$snap_conf${NC} for subvolume: ${YELLOW}$subvol${NC}..."

    # 1. Try Standard Lookup first
    # grep is quoted to handle spaces in description
    local snap_id=$(snapper -c "$snap_conf" list --columns number,description 2>/dev/null | grep "$TARGET_DESC" | tail -n 1 | awk '{print $1}')

    # 2. If Standard fails, try Rescue Mode (Only for root config)
    if [ -z "$snap_id" ] && [ "$snap_conf" == "root" ]; then
        echo -e "${YELLOW}  Standard lookup failed. Entering Rescue Mode...${NC}"
        # Capture output of function
        snap_id=$(get_id_rescue_mode)
    fi

    if [ -z "$snap_id" ]; then
        echo -e "${RED}  [SKIP] Snapshot matching '$TARGET_DESC' not found via any method.${NC}"
        return 1
    fi

    echo -e "  Found Snapshot ID: ${GREEN}$snap_id${NC}"

    # 3. Map to Btrfs-Assistant Index
    local ba_index=$(btrfs-assistant -l | awk -v v="$subvol" -v s="$snap_id" '$2==v && $3==s {print $1}')

    if [ -z "$ba_index" ]; then
        echo -e "${RED}  [FAIL] Could not map Snapper ID $snap_id to Btrfs-Assistant index.${NC}"
        echo -e "  (If inside a read-only snapshot, this is expected behavior for btrfs-assistant cli.)"
        echo -e "  ${YELLOW}MANUAL ACTION REQUIRED:${NC} Please use 'snapper rollback $snap_id' or 'btrfs subvolume snapshot' manually."
        return 1
    fi

    # 4. Confirmation
    if [ "$CONFIRMED" != "yes" ]; then
        echo -e "\n${RED}!!! WARNING: SYSTEM ROLLBACK INITIATED !!!${NC}"
        echo -e "Target Snapshot: ${YELLOW}$TARGET_DESC (ID: $snap_id)${NC}"
        echo -e "Any changes after this snapshot will be ${RED}LOST FOREVER${NC}."
        echo -e "The system will reboot immediately upon completion."
        echo -e ""
        read -p "Are you sure you want to proceed? [y/N]: " confirm
        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}Operation aborted.${NC}"
            exit 0
        fi
        CONFIRMED="yes"
        echo -e "${GREEN}Confirmed. Processing...${NC}\n"
    fi

    # 5. Execute Restore
    echo -e "  Executing rollback (Index: $ba_index)..."
    if btrfs-assistant -r "$ba_index"; then
        echo -e "  ${GREEN}Success.${NC}"
        return 0
    else
        echo -e "  ${RED}Restore command failed.${NC}"
        return 1
    fi
}

# --- Main Execution ---

CONFIRMED="no"

# 3. Rollback Root (Critical)
echo -e "${YELLOW}>>> Restoring Root Filesystem...${NC}"
if ! perform_rollback "@" "root"; then
    echo -e "${RED}CRITICAL FAILURE: Failed to restore root partition.${NC}"
    exit 1
fi

# 4. Rollback Home (Optional)
if snapper list-configs 2>/dev/null | grep -q "^home "; then
    echo -e "${YELLOW}>>> Restoring Home Filesystem...${NC}"
    perform_rollback "@home" "home"
else
    echo -e "No 'home' snapper config active, skipping home restore."
fi

# 5. Reboot
echo -e "${GREEN}System rollback successful.${NC}"
echo -e "${YELLOW}Rebooting in 3 seconds...${NC}"
sleep 3
reboot
