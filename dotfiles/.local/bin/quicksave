#!/bin/bash

# ==============================================================================
# 1. Localization Settings
# ==============================================================================
if env | grep -q "zh_CN"; then
    MSG_NO_ROOT="错误：未找到针对根目录 / 的 Snapper 配置"
    MSG_CONF_MISSING="配置文件丢失："
    MSG_CLEAN_OK="旧存档已清理"
    MSG_CLEAN_FAIL="错误：清理失败"
    MSG_SAVE_OK="已快速存档"
    MSG_SAVE_FAIL="错误：存档失败"
    MSG_PERMISSION_ERR="错误：存档失败，权限异常"
else
    MSG_NO_ROOT="ERROR: Snapper config for '/' not found."
    MSG_CONF_MISSING="Config file missing: "
    MSG_CLEAN_OK="Old save files cleaned."
    MSG_CLEAN_FAIL="ERROR: Clean process failed."
    MSG_SAVE_OK="Quicksaved."
    MSG_SAVE_FAIL="ERROR: Quicksave failed."
    MSG_PERMISSION_ERR="ERROR: Quicksave failed due to permission issues."
fi

# ==============================================================================
# 2. Argument Parsing
# ==============================================================================
usage() {
    echo "Usage: $(basename "$0") [-d description]"
    exit 1
}

# Default snapshot description
DESC="quicksave"

while getopts "d:h" opt; do
  case $opt in
    d)
      DESC="$OPTARG"
      ;;
    h)
      usage
      ;;
    \?)
      usage
      ;;
  esac
done

shift $((OPTIND -1))

# ==============================================================================
# 3. Detect Snapper Configurations
# ==============================================================================
# Auto-detect config names for Root and Home mount points
ROOT_CONF_NAME=$(snapper list-configs | awk '$3 == "/" {print $1}')
HOME_CONF_NAME=$(snapper list-configs | awk '$3 == "/home" {print $1}')

TARGETS=("$ROOT_CONF_NAME")
[ -n "$HOME_CONF_NAME" ] && TARGETS+=("$HOME_CONF_NAME")


if [ -z "$ROOT_CONF_NAME" ]; then
    notify-send -u critical "$MSG_NO_ROOT"
    exit 1
fi

# ==============================================================================
# 4. Permission Check & Auto-Repair
# ==============================================================================

# --- Root Config Check ---
ROOT_CONF_FILE="/etc/snapper/configs/$ROOT_CONF_NAME"

if [ -f "$ROOT_CONF_FILE" ]; then
    # Test read permission; if failed, escalate via pkexec to fix permissions and limits
    if ! snapper -c "$ROOT_CONF_NAME" get-config >/dev/null 2>&1; then
        pkexec snapper -c "$ROOT_CONF_NAME" set-config ALLOW_GROUPS="wheel" NUMBER_LIMIT=10 NUMBER_MIN_AGE=0
    fi
else
    notify-send -u critical "$MSG_CONF_MISSING $ROOT_CONF_FILE"
    exit 1
fi

# --- Home Config Check ---
if [ -n "$HOME_CONF_NAME" ]; then
    HOME_CONF_FILE="/etc/snapper/configs/$HOME_CONF_NAME"
    
    if [ -f "$HOME_CONF_FILE" ]; then
        # Same check logic for /home config
        if ! snapper -c "$HOME_CONF_NAME" get-config >/dev/null 2>&1; then
            pkexec snapper -c "$HOME_CONF_NAME" set-config ALLOW_GROUPS="wheel" NUMBER_LIMIT=10 NUMBER_MIN_AGE=0
        fi
    fi
fi

# ==============================================================================
# 5. Cleanup Old Snapshots
# ==============================================================================

CLEAN_SUCCESS=true

for conf in "${TARGETS[@]}"; do
    if ! snapper -c "$conf" cleanup number; then
        CLEAN_SUCCESS=false
    fi
done

if [ "$CLEAN_SUCCESS" = true ]; then
     notify-send "$MSG_CLEAN_OK"
fi

# ==============================================================================
# 6. Create New Snapshot
# ==============================================================================
SAVE_SUCCESS=true

for conf in "${TARGETS[@]}"; do
    if ! snapper -c "$conf" create --description "$DESC" --cleanup-algorithm number; then
        SAVE_SUCCESS=false
    fi
done

if [ "$SAVE_SUCCESS" = true ]; then
    notify-send "$MSG_SAVE_OK" "($DESC)"
else
    notify-send -u critical "$MSG_SAVE_FAIL"
fi
