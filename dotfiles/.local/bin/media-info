#!/bin/bash

# ===============================================================
#  Thunar Media Info v6.0 (Emoji Style + i18n Fix + Help)
# ===============================================================

# --- 1. é…ç½®åŒºåŸŸ ---
KITTY_CLASS="thunar_media_info_popup"

# --- 2. å¸®åŠ©ä¿¡æ¯å‡½æ•° (-h) ---
show_help() {
    echo "ç”¨æ³•: $(basename "$0") [é€‰é¡¹] <æ–‡ä»¶è·¯å¾„>"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -f <æ–‡ä»¶>   æŒ‡å®šè¾“å…¥æ–‡ä»¶ (Thunar å…¼å®¹æ¨¡å¼)"
    echo "  -h          æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $(basename "$0") video.mp4"
    echo "  $(basename "$0") -f video.mp4"
}

# --- 3. è¯­è¨€æ£€æµ‹ä¿®å¤ç‰ˆ ---
# ä¸å†ä¾èµ– locale å‘½ä»¤ï¼Œç›´æ¥è¯»å–ç¯å¢ƒå˜é‡ï¼Œè¿™æ˜¯æœ€ç¨³å¦¥çš„æ–¹å¼
# ä¼˜å…ˆçº§: LC_ALL > LC_MESSAGES > LANG
DETECTED_LANG="${LC_ALL:-${LC_MESSAGES:-$LANG}}"

if [[ "$DETECTED_LANG" == *"zh"* ]]; then
    UI_LANG="zh"
else
    UI_LANG="en"
fi

# --- 4. æœ¬åœ°åŒ–å­—å…¸ (å¸¦ Emoji çš„è§†è§‰é£æ ¼) ---
# æ ¼å¼: å˜é‡å | è‹±æ–‡å†…å®¹ | ä¸­æ–‡å†…å®¹
LANG_TABLE='
STR_ERR_INPUT    | Error: No input file.               | é”™è¯¯ï¼šæœªæ£€æµ‹åˆ°è¾“å…¥æ–‡ä»¶ã€‚
STR_ERR_FFMPEG   | Error: ffmpeg not found.            | é”™è¯¯ï¼šæœªæ‰¾åˆ° ffmpeg å‘½ä»¤ã€‚
STR_ERR_KITTY    | Error: Kitty not found.             | é”™è¯¯ï¼šæœªæ‰¾åˆ° Kitty ç»ˆç«¯ã€‚
STR_WIN_TITLE    | Media Info                          | åª’ä½“ä¿¡æ¯
STR_LBL_NAME     |  File    |  æ–‡ä»¶å
STR_LBL_PATH     |  Path    |  è·¯  å¾„
STR_LBL_TIME     |  Time    |  æ—¶  é•¿
STR_LBL_RATE     |  Rate    |  æ¯”ç‰¹ç‡
STR_LBL_VID      |  Video   |  è§†é¢‘æµ
STR_LBL_AUD      |  Audio   |  éŸ³é¢‘æµ
STR_Unknown      | Unknown                             | æœªçŸ¥
STR_Image        | (Image)                             | (å›¾ç‰‡)
STR_Stereo       | Stereo                              | åŒå£°é“
STR_Mono         | Mono                                | å•å£°é“
STR_Surround     | Surround                            | ç¯ç»•å£°
STR_PressKey     | Press any key to close...           | æŒ‰ä»»æ„é”®å…³é—­çª—å£...
'

# è§£æå­—å…¸
while IFS='|' read -r v e c; do
    v=$(echo "$v" | xargs)
    e=$(echo "$e" | xargs)
    c=$(echo "$c" | xargs)
    [ -z "$v" ] && continue
    case "$v" in \#*) continue ;; esac
    [ "$UI_LANG" = "zh" ] && eval "$v=\"$c\"" || eval "$v=\"$e\""
done <<EOF
$LANG_TABLE
EOF

# --- 5. å‚æ•°è§£æ (æ”¯æŒ -h å’Œ -f) ---
FILE=""
while getopts ":f:h" opt; do
  case $opt in
    f) FILE="$OPTARG" ;;
    h) show_help; exit 0 ;;
    *) ;;
  esac
done

# å¦‚æœæ²¡æœ‰é€šè¿‡ -f ä¼ å‚ï¼Œå°è¯•è¯»å–ä½ç½®å‚æ•°
if [ -z "$FILE" ]; then
    shift $((OPTIND-1))
    FILE="$1"
fi

# æ£€æŸ¥è¾“å…¥
if [ -z "$FILE" ]; then
    echo "$STR_ERR_INPUT"
    echo "Try '$(basename "$0") -h' for more information."
    exit 1
fi

FILENAME=$(basename -- "$FILE")
DIRNAME=$(dirname -- "$FILE")

# æ£€æŸ¥ä¾èµ–
if ! command -v ffmpeg &> /dev/null; then
    echo "$STR_ERR_FFMPEG"
    read -n 1
    exit 1
fi

# --- 6. Kitty è‡ªåŠ¨å¯åŠ¨é€»è¾‘ ---
if [ "$TERM" != "xterm-kitty" ] || [ "$KITTY_WINDOW_ID" == "" ]; then
    if command -v kitty &> /dev/null; then
        exec kitty \
            --class "$KITTY_CLASS" \
            --title "$STR_WIN_TITLE: $FILENAME" \
            -o initial_window_width=640 \
            -o initial_window_height=420 \
            -- "$0" "$FILE"
        exit
    else
        echo "$STR_ERR_KITTY"
        read -n 1
        exit 1
    fi
fi

# =========================================================
#                 æ•°æ®æ¸²æŸ“ (å¤åˆ»æˆªå›¾é£æ ¼)
# =========================================================

RAW_INFO=$(ffmpeg -i "$FILE" 2>&1)

# å®šä¹‰é¢œè‰²
BOLD='\033[1m'
GRAY='\033[90m'
CYAN='\033[36m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
RESET='\033[0m'

clear

# --- å¤´éƒ¨ ---
# ä½¿ç”¨ printf ä¿æŒå¯¹é½ï¼Œæ¨¡ä»¿æˆªå›¾ä¸­çš„ä¸¤è¡Œç´§å‡‘å¸ƒå±€
echo ""
printf " ${CYAN}%-10s${RESET}: ${BOLD}%s${RESET}\n" "$STR_LBL_NAME" "$FILENAME"
printf " ${CYAN}%-10s${RESET}: %s\n" "$STR_LBL_PATH" "$DIRNAME"

# è™šçº¿åˆ†å‰²
echo -e "${GRAY}----------------------------------------${RESET}"

# --- æ—¶é•¿ä¸æ¯”ç‰¹ç‡ ---
DURATION_LINE=$(echo "$RAW_INFO" | grep "Duration")
if [ -n "$DURATION_LINE" ] && ! echo "$DURATION_LINE" | grep -q "N/A"; then
    DUR=$(echo "$DURATION_LINE" | awk -F', ' '{print $1}' | sed 's/.*Duration: //')
    BITRATE=$(echo "$DURATION_LINE" | awk -F', ' '{print $3}' | sed 's/bitrate: //')
    
    echo ""
    printf " ${YELLOW}%-10s${RESET}: ${BOLD}%s${RESET}\n" "$STR_LBL_TIME" "$DUR"
    printf " ${YELLOW}%-10s${RESET}: %s\n" "$STR_LBL_RATE" "$BITRATE"
    echo ""
fi

# --- è§†é¢‘æµ ---
VIDEO_STREAMS=$(echo "$RAW_INFO" | grep "Stream.*Video")
if [ -n "$VIDEO_STREAMS" ]; then
    echo "$VIDEO_STREAMS" | while read -r line; do
        CODEC=$(echo "$line" | grep -oE "Video: [a-zA-Z0-9]+" | cut -d' ' -f2)
        RES=$(echo "$line" | grep -oE "[0-9]{3,5}x[0-9]{3,5}" | head -1)
        FPS=$(echo "$line" | grep -oE "[0-9.]+\s+fps" | head -1)
        
        # æ ¼å¼åŒ–è¾“å‡º (æ¨¡ä»¿æˆªå›¾: ğŸ¬ è§†é¢‘æµ: hevc | 2560x1440 | 78.98 fps)
        if [ -n "$FPS" ]; then
            INFO_STR="$CODEC | $RES | $FPS"
        else
            INFO_STR="$CODEC $STR_Image | $RES"
        fi
        
        printf " ${BLUE}%-9s${RESET}: %s\n" "$STR_LBL_VID" "$INFO_STR"
    done
fi

# --- éŸ³é¢‘æµ ---
AUDIO_STREAMS=$(echo "$RAW_INFO" | grep "Stream.*Audio")
if [ -n "$AUDIO_STREAMS" ]; then
    echo "$AUDIO_STREAMS" | while read -r line; do
        CODEC=$(echo "$line" | grep -oE "Audio: [a-zA-Z0-9]+" | cut -d' ' -f2)
        HZ=$(echo "$line" | grep -oE "[0-9]+\s+Hz")
        
        # å£°é“åˆ¤æ–­
        CHANNEL="$STR_Unknown"
        if echo "$line" | grep -q "stereo"; then CHANNEL="$STR_Stereo"; 
        elif echo "$line" | grep -q "mono"; then CHANNEL="$STR_Mono"; 
        else 
             # æå–æ•°å­—å£°é“
             CH_NUM=$(echo "$line" | grep -oE ", [0-9]+ channels" | tr -d ', a-z')
             [ -n "$CH_NUM" ] && CHANNEL="$CH_NUM $STR_Surround"
        fi

        # æ ¼å¼åŒ–è¾“å‡º
        INFO_STR="$CODEC | $HZ | $CHANNEL"
        printf " ${GREEN}%-9s${RESET}: %s\n" "$STR_LBL_AUD" "$INFO_STR"
    done
fi

# --- åº•éƒ¨ ---
echo ""
echo -e "${GRAY}----------------------------------------${RESET}"
echo -e "${BOLD}$STR_PressKey${RESET}"

# éšè—å…‰æ ‡å¹¶ç­‰å¾…
tput civis 
read -n 1 -s -r
tput cnorm
