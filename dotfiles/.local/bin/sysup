#!/bin/bash

# ===============================================================
# Arch Linux 系统更新助手 (完美版)
# ===============================================================
# 【整体功能概述】
# 01. 支持从 Arch Linux 官方/中文社区获取最新新闻资讯
# 02. 智能解析新闻并高亮显示需要"手动干预"的警告信息
# 03. 等待用户确认后执行系统更新
# 04. 自动检测并优先使用 AUR 助手 (paru 或 yay)
# 05. 智能更新 GPG 密钥环 (自动扫描 pacman.conf 识别 archlinuxcn)
# 06. 自动静默更新 Flatpak 应用 (如果已安装)
# 07. 更新后自动执行 GRUB 配置更新 (grub-mkconfig)
# 08. 自动请求并后台保持 sudo 权限 (使用 trap 机制安全退出)
# 09. 自动检测系统语言 (zh_CN) 实现中英双语支持
# 10. 更新完成后静默刷新 Waybar 模块
# ===============================================================
# 【命令行参数】
# --ui-lang      zh|en         指定脚本交互语言 (默认: 自动检测)
# --news-source  official|cn   指定新闻源语言 (默认: official)
# --count N                    限制最多显示的新闻条数 (默认: 15)
# --help, -h                   显示帮助信息
# ===============================================================

# ------------------------------
# 1. Default parameters
# ------------------------------
COUNT_LIMIT=15       # Default max news items
NEWS_SOURCE="official" # Default source
UI_LANG=$(
    locale 2>/dev/null |
    awk -F= '/^LC_MESSAGES=/{print $2}' |
    grep -q zh_CN && echo zh || echo en
)

# ------------------------------
# 2. Define Colors
# ------------------------------
NC='\033[0m'
H_RED='\033[1;31m'
H_GREEN='\033[1;32m'
H_YELLOW='\033[1;33m'
H_BLUE='\033[1;34m'
H_CYAN='\033[1;36m'  # 用于标题栏

# ------------------------------
# 3. Argument parsing
# ------------------------------
usage() {
    cat <<EOF
Usage: $(basename "$0") [options]

Options:
  --ui-lang zh|en        UI language (default: auto)
  --news-source official|cn  News source (default: official)
  --count N                    Max number of news items (default: 15)
  --help, -h                   Show this help and exit
EOF
}

while [ $# -gt 0 ]; do
    case "$1" in
        --ui-lang)     [ -n "$2" ] && UI_LANG="$2" && shift 2 || exit 1 ;;
        --news-source) [ -n "$2" ] && NEWS_SOURCE="$2" && shift 2 || exit 1 ;;
        --count)       [ -n "$2" ] && COUNT_LIMIT="$2" && shift 2 || exit 1 ;;
        --help|-h)     usage; exit 0 ;;
        *)             printf "Unknown option: %s\n" "$1"; usage; exit 1 ;;
    esac
done

# ------------------------------
# 4. Localization Logic
# ------------------------------
LANG_TABLE='
TAG_INFO         | [INFO]                                          | [消息]
TAG_SUCCESS      | [OK]                                            | [成功]
TAG_WARN         | [WARN]                                          | [注意]
TAG_ERROR        | [ERROR]                                         | [错误]

INTRO_HEADER      | === Arch Linux System Update Assistant ===      | === Arch Linux 系统更新助手 ===
INTRO_DESC       | Actions to perform:                              | 本脚本将执行以下操作：
INTRO_1          | 1. Fetch latest Arch Linux news                 | 1. 获取最新 Arch Linux 新闻
INTRO_2          | 2. Sync Pacman DB & Update GPG Keyrings          | 2. 同步软件数据库并更新 GPG 密钥环
INTRO_3          | 3. Upgrade system packages                      | 3. 升级系统软件包 
INTRO_4          | 4. Update Flatpak apps                          | 4. 更新 Flatpak 应用
INTRO_5          | 5. Re-generate GRUB config                      | 5. 重新生成 GRUB 配置文件

MSG_REQ_SUDO      | Requesting sudo...                              | 正在请求管理员权限以更新系统...
MSG_SUDO_FAIL    | Sudo privileges required. Exiting...            | 需要管理员权限才能更新系统。已退出。
MSG_NO_HELPER    | No AUR helper found (paru or yay)               | 未找到 AUR 助手 (paru 或 yay)
MSG_PREPARING    | Preparing update with %s...                     | 准备使用 %s 更新系统...
MSG_FETCHING     | Fetching news...                                | 正在获取 Arch Linux 新闻...
MSG_NEWS_HEADER  | Recent {0} Arch Linux news items:               | 最近 {0} 条 Arch Linux 新闻：
MSG_CONFIRM      | Proceed with %s? [Y/n]                          | 请阅读上述新闻。确认使用 %s 继续更新吗？[Y/n]
MSG_CANCEL       | Update cancelled.                               | 更新已取消。
MSG_ERR_FETCH    | Failed to fetch news                            | 获取新闻失败（网络或源错误）
MSG_FORCE_ASK    | Force update anyway? [y/N]                      | 是否忽略新闻强制更新？[y/N]
MSG_FORCING      | Forcing update...                               | 正在强制更新...
MSG_EXIT         | Safe exit.                                      | 安全退出。

MSG_SNAP         | [0/5] Creating Btrfs Snapshot...                | [0/5] 正在创建 Btrfs 快照...
MSG_STEP_1       | [1/5] Sync DB & Keyrings                        | [1/5] 同步数据库并更新密钥环...
MSG_KEYRING_OK   | DB & Keyrings synced.                           | 数据库与密钥环已同步。
MSG_KEYRING_WARN | Keyring issues detected...                      | 密钥环更新遇到问题，继续尝试系统更新...
MSG_STEP_2       | [2/5] Upgrading system                          | [2/5] 正在升级系统...
MSG_STEP_3       | [3/5] Checking Flatpak updates                  | [3/5] 检查 Flatpak 更新...
MSG_STEP_4       | [4/5] Updating GRUB                             | [4/5] 更新 GRUB 配置...
MSG_GRUB_OK      | GRUB updated.                                   | GRUB 更新成功。
MSG_GRUB_FAIL    | GRUB update failed.                             | GRUB 更新失败。
'

while IFS='|' read -r v e c; do
    v=$(printf '%s' "$v" | sed 's/^ *//;s/ *$//')
    e=$(printf '%s' "$e" | sed 's/^ *//;s/ *$//')
    c=$(printf '%s' "$c" | sed 's/^ *//;s/ *$//')
    [ -z "$v" ] && continue
    case "$v" in \#*) continue ;; esac
    [ "$UI_LANG" = "zh" ] && eval "$v=\"\$c\"" || eval "$v=\"\$e\""
done <<EOF
$LANG_TABLE
EOF

# ------------------------------
# 5. Logging Functions
# ------------------------------
_log() { printf "${H_BLUE}${TAG_INFO}${NC} %s\n" "$1"; }
_success() { printf "${H_GREEN}${TAG_SUCCESS}${NC} %s\n" "$1"; }
_warn() { printf "${H_YELLOW}${TAG_WARN}${NC} %s\n" "$1"; }
_error() { printf "${H_RED}${TAG_ERROR}${NC} %s\n" "$1"; exit 1; }

# ------------------------------
# 6. Intro & Request Privileges
# ------------------------------
printf "\n${H_CYAN}%s${NC}\n" "$INTRO_HEADER"
printf "%s\n" "$INTRO_DESC"
printf "  %s\n" "$INTRO_1"
printf "  %s\n" "$INTRO_2"
printf "  %s\n" "$INTRO_3"
printf "  %s\n" "$INTRO_4"
printf "  %s\n\n" "$INTRO_5"

_log "$MSG_REQ_SUDO"
if ! sudo -v; then
    _error "$MSG_SUDO_FAIL"
fi

# Keep sudo alive in background
while true; do sudo -n true; sleep 60; done 2>/dev/null &
SUDO_PID=$!
trap 'kill $SUDO_PID 2>/dev/null' EXIT

# ------------------------------
# 7. Check AUR Helper
# ------------------------------
UPDATE_CMD=""
if command -v paru >/dev/null 2>&1; then
    UPDATE_CMD="paru"
elif command -v yay >/dev/null 2>&1; then
    UPDATE_CMD="yay"
else
    _error "$MSG_NO_HELPER"
fi

# ------------------------------
# 8. Update Function
# ------------------------------
perform_update() {
    # Step 0: Quick Snapshot (Before everything)
    if command -v quicksave >/dev/null 2>&1; then
        _log "$MSG_SNAP"
        quicksave -d sysup
    fi

    # Step 1: Sync DB & Update keyrings
    _log "$MSG_STEP_1"
    KEYRING_TARGETS="archlinux-keyring"
    if grep -q "^\[archlinuxcn\]" /etc/pacman.conf; then
        KEYRING_TARGETS="$KEYRING_TARGETS archlinuxcn-keyring"
    fi

    if sudo pacman -Sy --needed --noconfirm $KEYRING_TARGETS; then
        _success "$MSG_KEYRING_OK"
    else
        _warn "$MSG_KEYRING_WARN"
    fi

    # Step 2: Upgrade system
    _log "$MSG_STEP_2"
    $UPDATE_CMD -Syu

    # Step 3: Flatpak
    if command -v flatpak >/dev/null 2>&1; then
        _log "$MSG_STEP_3"
        flatpak update -y
    fi

    # Step 4: Update GRUB
    _log "$MSG_STEP_4"
    if command -v grub-mkconfig >/dev/null 2>&1; then
        if sudo env LANG=en_US.UTF-8 grub-mkconfig -o /boot/grub/grub.cfg; then
            _success "$MSG_GRUB_OK"
        else
            _warn "$MSG_GRUB_FAIL"
        fi
    else
        _warn "grub-mkconfig not found. Skipping GRUB update."
    fi

    # Step 5: Silent Waybar Refresh
    pkill -RTMIN+8 waybar >/dev/null 2>&1
}

# ------------------------------
# 9. Main Execution
# ------------------------------
_log "$(printf "$MSG_PREPARING" "$UPDATE_CMD")"
_log "$MSG_FETCHING"

# Python script for news parsing
PYTHON_SCRIPT=$(cat <<'EOF'
import sys
import xml.etree.ElementTree as ET
try:
    limit = int(sys.argv[1])
    header_template = sys.argv[2]
    sys.stdin.reconfigure(encoding='utf-8')
    raw_data = sys.stdin.read()
    if not raw_data.strip(): sys.exit(1)
    root = ET.fromstring(raw_data)
    items = root.findall('./channel/item')[:limit]
    print(f'\n\033[1;33m{header_template.format(len(items))}\033[0m\n')
    for item in items:
        title = item.find('title').text
        pub_date = item.find('pubDate').text
        date_str = pub_date[:16]
        check_text = title.lower()
        if any(x in check_text for x in ['intervention', 'manual', '手动', '干预']):
            color = '\033[1;31m'; prefix = '!!! '
        else:
            color = '\033[1;32m'; prefix = ''
        print(f'{color}[{date_str}] {prefix}{title}\033[0m')
except Exception as e:
    sys.stderr.write(f'\nParse Error: {e}\n')
    sys.exit(1)
EOF
)

if [ "$NEWS_SOURCE" = "cn" ]; then
    NEWS_URL="https://www.archlinuxcn.org/category/news/feed/"
else
    NEWS_URL="https://archlinux.org/feeds/news/"
fi

if curl -sS -L --connect-timeout 15 -A "Mozilla/5.0" "$NEWS_URL" \
    | python -c "$PYTHON_SCRIPT" "$COUNT_LIMIT" "$MSG_NEWS_HEADER"; then
    
    printf "\n"
    printf "$MSG_CONFIRM" "$UPDATE_CMD"
    read -r confirm
    case "$confirm" in
        [Yy]*|"" ) perform_update ;;
        * ) _warn "$MSG_CANCEL"; exit 0 ;;
    esac
else
    printf "\n"
    _warn "$MSG_ERR_FETCH"
    printf "$MSG_FORCE_ASK"
    read -r force_confirm
    case "$force_confirm" in
        [Yy]* ) _warn "$MSG_FORCING"; perform_update ;;
        * ) _log "$MSG_EXIT"; exit 1 ;;
    esac
fi
