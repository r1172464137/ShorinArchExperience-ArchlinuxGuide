#!/bin/bash

# ================= é…ç½®åŒº =================
DB_FILE="$HOME/.cache/shorinclip/history.db"
CACHE_DIR="$HOME/.cache/shorinclip/previews"
FMT_CMD="sed 's/\[\[ binary data.*\]\]/ [ğŸ–¼ï¸  Image] /g'"

mkdir -p "$CACHE_DIR"
mkdir -p "$(dirname "$DB_FILE")"

# ================= æ¸…ç†å‡½æ•° =================
cleanup() {
    rm -f "$CACHE_DIR"/*
    kitten icat --clear --stdin=no --silent --transfer-mode=memory < /dev/null > /dev/tty 2>/dev/null
}

# ================= æ ¸å¿ƒé€»è¾‘ =================

case "$1" in
    # --- é¢„è§ˆæ¨¡å¼ (ä¿æŒä¸å˜) ---
    preview)
        ID="$2"
        if [[ ! "$ID" =~ ^[0-9]+$ ]]; then exit 0; fi

        OUTPUT_IMG="$CACHE_DIR/${ID}" 
        
        if [ ! -s "$OUTPUT_IMG" ]; then
            cliphist -db-path "$DB_FILE" decode "$ID" > "$OUTPUT_IMG"
        fi
        
        MIME=$(file --mime-type -b "$OUTPUT_IMG")
        
        IS_URI=false
        if [[ $(head -c 7 "$OUTPUT_IMG") == "file://" ]]; then
            IS_URI=true
            REAL_PATH=$(python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip().replace('file://', '')))" < "$OUTPUT_IMG" 2>/dev/null)
        fi

        IMG_W=$((FZF_PREVIEW_COLUMNS - 2))
        IMG_H=$((FZF_PREVIEW_LINES - 1))
        if [[ $IMG_W -lt 1 ]]; then IMG_W=10; fi
        if [[ $IMG_H -lt 1 ]]; then IMG_H=10; fi

        if [[ "$MIME" == image/* ]]; then
            echo " " 
            sleep 0.2
            kitten icat --clear --transfer-mode=memory --stdin=no \
                --place "${IMG_W}x${IMG_H}@0x0" \
                "$OUTPUT_IMG" 2>/dev/null 

        elif [ "$IS_URI" = true ] && [ -f "$REAL_PATH" ]; then
             REAL_MIME=$(file --mime-type -b "$REAL_PATH")
             if [[ "$REAL_MIME" == image/* ]]; then
                echo " " 
                sleep 0.2
                kitten icat --clear --transfer-mode=memory --stdin=no \
                    --place "${IMG_W}x${IMG_H}@0x0" \
                    "$REAL_PATH" 2>/dev/null
             else
                echo -e "\033[32m[File Path Detected]\033[0m"
                echo "Path: $REAL_PATH"
                echo "Type: $REAL_MIME"
                echo "---"
                if command -v bat >/dev/null 2>&1; then
                    bat --color=always --style=plain --paging=never "$REAL_PATH" 2>/dev/null || ls -lh "$REAL_PATH"
                else
                    ls -lh "$REAL_PATH"
                fi
             fi
        else
            kitten icat --clear --stdin=no --silent --transfer-mode=memory < /dev/null > /dev/tty 2>/dev/null
            if command -v bat >/dev/null 2>&1; then
                bat --color=always --style=plain --paging=never "$OUTPUT_IMG"
            else
                cat "$OUTPUT_IMG"
            fi
        fi
        ;;

    # --- ä¸»ç•Œé¢ ---
    *)
        trap cleanup EXIT

        if [ -z "$(cliphist -db-path "$DB_FILE" list | head -n 1)" ]; then
            echo "ğŸ“‹ ShorinClip ä¸ºç©º"
            read -n 1
            exit 0
        fi

        # åˆ—è¡¨ UI
        SELECTED=$(cliphist -db-path "$DB_FILE" list | \
            awk '{printf "\033[90m%-3d\033[0m\t%s\n", NR, $0}' | \
            eval "$FMT_CMD" | \
            fzf \
            --ansi \
            --delimiter=$'\t' \
            --with-nth=1,3.. \
            --tabstop=1 \
            --preview "$0 preview {2}" \
            --preview-window=:60%:border-top:wrap \
            --bind "ctrl-x:execute(cliphist -db-path '$DB_FILE' delete <<< {2})+reload(cliphist -db-path '$DB_FILE' list | awk '{printf \"\033[90m%-3d\033[0m\t%s\n\", NR, \$0}' | eval \"$FMT_CMD\")" \
            --header="[Enter] å¤åˆ¶  [Ctrl-X] åˆ é™¤" \
            --prompt="ğŸ“ Clip > " \
            --layout=reverse \
            --info=inline \
            --border=none \
            --margin=0 \
            --padding=0 \
            --height=100%
        )

        if [ -n "$SELECTED" ]; then
            ID=$(echo "$SELECTED" | cut -f2)
            
            # ğŸš€ ç»ˆæä¿®å¤ï¼šä½¿ç”¨ setsid å°†è¿›ç¨‹å½»åº•å‰¥ç¦»
            # setsid -f : å¼ºåˆ¶åœ¨åå°è¿è¡Œæ–°ä¼šè¯
            # sh -c "..." : å°†æ•´ä¸ªç®¡é“ä½œä¸ºä¸€ä¸ªç‹¬ç«‹å‘½ä»¤æ‰§è¡Œ
            
            if cliphist -db-path "$DB_FILE" decode "$ID" | head -c 7 | grep -q "^file://"; then
                # æƒ…å†µA: æ–‡ä»¶è·¯å¾„ -> ç‹¬ç«‹åå°æ‰§è¡Œ
                setsid -f sh -c "cliphist -db-path '$DB_FILE' decode '$ID' | wl-copy --type text/uri-list" >/dev/null 2>&1
            else
                # æƒ…å†µB: æ™®é€šå†…å®¹ -> ç‹¬ç«‹åå°æ‰§è¡Œ
                setsid -f sh -c "cliphist -db-path '$DB_FILE' decode '$ID' | wl-copy" >/dev/null 2>&1
            fi
        fi
        
        # è„šæœ¬ç«‹å³é€€å‡ºï¼Œç»ä¸å¡é¡¿ï¼Œåå°å¤åˆ¶ä¾ç„¶å­˜æ´»
        exit 0
        ;;
esac
