#!/bin/bash

# ================= é…ç½®åŒº =================
DB_FILE="$HOME/.cache/shorinclip/history.db"
CACHE_DIR="$HOME/.cache/shorinclip/previews"
# å®šä¹‰åˆ—è¡¨ç¾åŒ–é€»è¾‘ï¼Œé¿å…é‡å¤ä»£ç 
FMT_CMD="sed 's/\[\[ binary data.*\]\]/ [ğŸ–¼ï¸  Image] /g'"

mkdir -p "$CACHE_DIR"
mkdir -p "$(dirname "$DB_FILE")"

# ================= æ¸…ç†å‡½æ•° =================
cleanup() {
    # é€€å‡ºæ—¶æ¸…ç©ºç¼“å­˜ç›®å½•ï¼Œä¿è¯ä¸‹æ¬¡å¯åŠ¨æ˜¯å¹²å‡€çš„
    rm -f "$CACHE_DIR"/*
    kitten icat --clear --stdin=no --silent --transfer-mode=memory < /dev/null > /dev/tty
}

# ================= æ ¸å¿ƒé€»è¾‘ =================

case "$1" in
    # --- é¢„è§ˆæ¨¡å¼ ---
    preview)
        ID="$2"
        OUTPUT_IMG="$CACHE_DIR/${ID}" # å»æ‰åç¼€ï¼Œå…ˆåˆ¤æ–­ç±»å‹
        
        # ğŸš€ ä¼˜åŒ–1ï¼šç¼“å­˜æœºåˆ¶
        # åªæœ‰å½“æ–‡ä»¶ä¸å­˜åœ¨(æˆ–è€…ä¸ºç©º)æ—¶ï¼Œæ‰æ‰§è¡Œè§£ç ã€‚
        # è¿™æ ·åœ¨åˆ—è¡¨ä¸­ä¸Šä¸‹å¿«é€Ÿæ»šåŠ¨æ—¶ï¼Œä¸ç”¨é‡å¤æ¶ˆè€— CPU è§£ç å›¾ç‰‡ã€‚
        if [ ! -s "$OUTPUT_IMG" ]; then
            cliphist -db-path "$DB_FILE" decode "$ID" > "$OUTPUT_IMG"
        fi
        
        MIME=$(file --mime-type -b "$OUTPUT_IMG")
        
        if [[ "$MIME" == image/* ]]; then
            # === å›¾ç‰‡æ¨¡å¼ ===
            sleep 0.2
            kitten icat --clear --transfer-mode=memory --stdin=no \
                --place "${FZF_PREVIEW_COLUMNS}x${FZF_PREVIEW_LINES}@0x0" \
                "$OUTPUT_IMG"
        else
            # === æ–‡æœ¬æ¨¡å¼ ===
            # æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å›¾ç‰‡
            kitten icat --clear --stdin=no --silent --transfer-mode=memory < /dev/null > /dev/tty 2>/dev/null
            
            # ğŸš€ ä¼˜åŒ–2ï¼šè¯­æ³•é«˜äº®
            # å¦‚æœå®‰è£…äº† batï¼Œå°±ç”¨ bat æ¸²æŸ“ï¼›å¦åˆ™é™çº§ç”¨ cat
            if command -v bat >/dev/null 2>&1; then
                bat --color=always --style=plain --paging=never "$OUTPUT_IMG"
            else
                cat "$OUTPUT_IMG"
            fi
        fi
        ;;

    # --- ä¸»ç•Œé¢ ---
    *)
        trap cleanup EXIT

        # å¿«é€Ÿæ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹
        if [ -z "$(cliphist -db-path "$DB_FILE" list | head -n 1)" ]; then
            echo "ğŸ“‹ ShorinClip ä¸ºç©º"
            read -n 1
            exit 0
        fi

        # ğŸš€ ä¼˜åŒ–3ï¼šä½¿ç”¨ eval åŠ¨æ€æ‰§è¡Œ FMT_CMDï¼Œä¿æŒä»£ç æ•´æ´
        SELECTED=$(cliphist -db-path "$DB_FILE" list | \
            eval "$FMT_CMD" | \
            fzf \
            --delimiter=$'\t' \
            --with-nth=2.. \
            --preview "$0 preview {1}" \
            --preview-window=down:45%:wrap \
            --bind "ctrl-x:execute(cliphist -db-path '$DB_FILE' delete <<< {})+reload(cliphist -db-path '$DB_FILE' list | eval \"$FMT_CMD\")" \
            --header="[Enter] å¤åˆ¶  [Ctrl-X] åˆ é™¤" \
            --prompt="ğŸ“ Clip > " \
            --layout=reverse \
            --info=inline \
            --border=rounded \
            --height=100%
        )

        if [ -n "$SELECTED" ]; then
            ID=$(echo "$SELECTED" | cut -f1)
            cliphist -db-path "$DB_FILE" decode "$ID" | wl-copy > /dev/null 2>&1
        fi
        
        exit 0
        ;;
esac
