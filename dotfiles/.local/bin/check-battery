#!/bin/bash

# 颜色定义
BOLD='\033[1m'
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
NC='\033[0m'

# 获取电池信息
BAT_PATH=$(upower -e | grep battery | head -n 1)

if [ -z "$BAT_PATH" ]; then
    echo -e "${RED}${BOLD}[Error] 未检测到电池设备${NC}"
    exit 1
fi

INFO=$(upower -i "$BAT_PATH")

MODEL=$(echo "$INFO" | grep "model" | sed 's/^.*model: *//')
STATUS=$(echo "$INFO" | grep "state" | awk '{print $2}')
PERCENT=$(echo "$INFO" | grep "percentage" | awk '{print $2}')
HEALTH=$(echo "$INFO" | grep "capacity:" | awk '{print $2}')

# 如果没有 capacity 字段，尝试通过设计容量计算
FULL_DESIGN=$(echo "$INFO" | grep "energy-full-design" | awk '{print $2}')
FULL_NOW=$(echo "$INFO" | grep "energy-full:" | awk '{print $2}')
FULL_DESIGN_TXT=$(echo "$INFO" | grep "energy-full-design" | awk '{print $2, $3}')
FULL_NOW_TXT=$(echo "$INFO" | grep "energy-full:" | awk '{print $2, $3}')

if [ -z "$HEALTH" ] && [ -n "$FULL_DESIGN" ] && [ -n "$FULL_NOW" ]; then
    HEALTH=$(awk "BEGIN {printf \"%.2f%%\", ($FULL_NOW / $FULL_DESIGN) * 100}")
fi

# 状态颜色逻辑
if [[ "$STATUS" == "charging" ]]; then
    S_COLOR="$GREEN"; STATUS_TEXT="充电中 ⚡"
elif [[ "$STATUS" == "discharging" ]]; then
    S_COLOR="$YELLOW"; STATUS_TEXT="放电中 🔋"
elif [[ "$STATUS" == "fully-charged" ]]; then
    S_COLOR="$BLUE"; STATUS_TEXT="已充满 🔌"
else
    S_COLOR="$NC"; STATUS_TEXT="$STATUS"
fi

# 健康度颜色逻辑
HEALTH_NUM=$(echo "$HEALTH" | tr -d -c 0-9. | cut -d. -f1)
if [ -n "$HEALTH_NUM" ]; then
    if [ "$HEALTH_NUM" -ge 80 ]; then
        H_COLOR="$GREEN"
    elif [ "$HEALTH_NUM" -ge 60 ]; then
        H_COLOR="$YELLOW"
    else
        H_COLOR="$RED"
    fi
else
    H_COLOR="$NC"
fi

# 输出
echo -e ""
echo -e " ${BOLD}${CYAN}=== 电池健康报告 ===${NC}"
echo -e ""
echo -e " ${BOLD}设备型号:${NC}    $MODEL"
echo -e " ${BOLD}当前状态:${NC}    ${S_COLOR}${STATUS_TEXT}${NC}"
echo -e " ${BOLD}当前电量:${NC}    ${S_COLOR}${PERCENT}${NC}"
echo -e "${CYAN} -----------------------${NC}"
echo -e " ${BOLD}电池健康度:${NC}  ${H_COLOR}${HEALTH}${NC}"
echo -e "${CYAN} -----------------------${NC}"
echo -e " ${BOLD}设计容量:${NC}    $FULL_DESIGN_TXT"
echo -e " ${BOLD}实际容量:${NC}    $FULL_NOW_TXT"
echo -e ""
