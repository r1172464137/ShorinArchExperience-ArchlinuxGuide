#!/bin/bash
export SHELL=$(command -v bash)
# Wayland --> X11 剪贴板同步
sleep 0.1

# ==========================================
# 日志函数定义
# ==========================================
log() {
    local level="$1"
    local msg="$2"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $msg"
}

# 空字符串的 MD5，用于检测读取失败
EMPTY_MD5="d41d8cd98f00b204e9800998ecf8427e"

log "INFO" "=== 脚本触发: 开始检测剪贴板数据类型 ==="

TYPE=$(wl-paste --list-types 2>/dev/null)
CLEAN_TYPES=$(echo "$TYPE" | tr '\n' ',' | sed 's/,$//')
log "DEBUG" "检测到的源类型列表: [$CLEAN_TYPES]"

# ==========================================
# 1. 文件链接 (text/uri-list)
# ==========================================
if [[ "$TYPE" =~ "text/uri-list" ]]; then 
    log "INFO" "匹配类型: 文件链接 (text/uri-list)"
    
    # 计算哈希 (两边都去掉 'file://' 前缀，忽略协议头差异)
    W_HASH=$(wl-paste -t text/uri-list 2>/dev/null | sed 's|^file://||' | tr -d '\n' | md5sum | awk '{print $1}')
    X_HASH=$(xclip -o -sel clip -t x-special/gnome-copied-files 2>/dev/null | tail -n +2 | sed 's|^file://||' | md5sum | awk '{print $1}')
    
    if [[ "$W_HASH" == "$EMPTY_MD5" ]]; then
        log "WARN" "Wayland 文件列表为空，跳过。"
        exit 0
    fi

    log "DEBUG" "哈希比对 (已去头): Wayland[${W_HASH:0:8}...] vs X11[${X_HASH:0:8}...]"

    if [ "$W_HASH" != "$X_HASH" ]; then
        log "ACTION" "正在同步文件链接到 X11 (标准化为 file:// URI)..."
        
        # 同步逻辑: 构造 copy 头 + 补全 file:// 前缀
        { echo "copy"; wl-paste -t text/uri-list | sed 's|^/|file:///|'; } | xclip -sel clip -t x-special/gnome-copied-files
        
        if [ $? -eq 0 ]; then log "SUCCESS" "文件链接同步完成"; else log "ERROR" "文件链接同步失败"; fi
    else 
        log "SKIP" "内容重复，已跳过"
    fi

# ==========================================
# 2. QQ / HTML 富文本
# ==========================================
elif [[ "$TYPE" =~ "text/html" ]]; then
    log "INFO" "匹配类型: HTML / QQ 富文本"

    # 读取 Wayland (优先取 text/html)
    W_HASH=$(timeout 1s wl-paste -t text/html 2>/dev/null | md5sum | awk '{print $1}')

    # 防空检查
    if [[ "$W_HASH" == "$EMPTY_MD5" ]] || [[ -z "$W_HASH" ]]; then
        log "WARN" "读取 HTML 数据为空，跳过同步。"
        exit 0
    fi

    # 读取 X11 对比
    X_HASH=$(timeout 1s xclip -o -sel clip -t text/html 2>/dev/null | md5sum | awk '{print $1}')
    
    log "DEBUG" "哈希比对: Wayland[${W_HASH:0:8}...] vs X11[${X_HASH:0:8}...]"

    if [[ "$W_HASH" != "$X_HASH" ]]; then
        log "ACTION" "内容不同，正在同步 HTML 到 X11..."
        
        # 同步 text/html 即可兼容大多数程序
        wl-paste -t text/html | xclip -sel clip -t text/html
        
        if [ $? -eq 0 ]; then log "SUCCESS" "HTML 同步完成"; else log "ERROR" "HTML 同步失败"; fi
    else 
        log "SKIP" "内容重复，已跳过"
    fi

# ==========================================
# 3. 图片 (智能探测 PNG/JPEG)
# ==========================================
elif [[ "$TYPE" =~ "image/" ]]; then
    log "INFO" "匹配类型: 图片 (image/*) - 智能探测"
    
    # --- 尝试获取数据 ---
    
    # 1. 优先尝试 PNG
    TARGET_MIME="image/png"
    log "DEBUG" "尝试读取格式: $TARGET_MIME"
    W_HASH=$(timeout 1s wl-paste -t "$TARGET_MIME" 2>/dev/null | md5sum | awk '{print $1}')

    # 2. 如果 PNG 读取失败，降级尝试 JPEG
    if [[ "$W_HASH" == "$EMPTY_MD5" ]] || [[ -z "$W_HASH" ]]; then
        log "WARN" "读取 PNG 失败，尝试降级为 JPEG..."
        
        TARGET_MIME="image/jpeg"
        W_HASH=$(timeout 1s wl-paste -t "$TARGET_MIME" 2>/dev/null | md5sum | awk '{print $1}')
        
        # 3. 如果 JPEG 也失败，放弃
        if [[ "$W_HASH" == "$EMPTY_MD5" ]] || [[ -z "$W_HASH" ]]; then
            log "ERROR" "无法读取图片数据 (PNG/JPEG 均为空)，停止同步。"
            exit 0
        else
            log "INFO" "成功切换为 JPEG 格式 ($TARGET_MIME)"
        fi
    fi

    # --- 与 X11 对比 ---
    
    log "DEBUG" "正在对比 X11 中的 [$TARGET_MIME]..."
    X_HASH=$(timeout 1s xclip -o -sel clip -t "$TARGET_MIME" 2>/dev/null | md5sum | awk '{print $1}')
    
    log "DEBUG" "哈希比对 ($TARGET_MIME): Wayland[${W_HASH:0:8}...] vs X11[${X_HASH:0:8}...]"

    if [[ "$W_HASH" != "$X_HASH" ]]; then
        log "ACTION" "内容不同，正在以 [$TARGET_MIME] 格式同步到 X11..."
        
        wl-paste -t "$TARGET_MIME" | xclip -sel clip -t "$TARGET_MIME"
        
        if [ $? -eq 0 ]; then log "SUCCESS" "图片同步完成"; else log "ERROR" "图片同步失败"; fi
    else 
        log "SKIP" "内容重复，已跳过"
    fi 

# ==========================================
# 4. 纯文字 (text/plain)
# ==========================================
elif [[ "$TYPE" =~ "text/plain" ]]; then 
    log "INFO" "匹配类型: 纯文字 (text/plain)"
    
    W_HASH=$(wl-paste -t text/plain 2>/dev/null | tr -d '\n' | md5sum | awk '{print $1}')
    
    if [[ "$W_HASH" == "$EMPTY_MD5" ]]; then
        log "WARN" "Wayland 文本为空，跳过同步。"
        exit 0
    fi
    
    X_HASH=$(xclip -o -sel clip -t UTF8_STRING 2>/dev/null | tr -d '\n' | md5sum | awk '{print $1}')

    if [ "$W_HASH" != "$X_HASH" ]; then
        log "ACTION" "正在同步纯文字到 X11..."
        wl-paste | xclip -sel clip -t UTF8_STRING
        if [ $? -eq 0 ]; then log "SUCCESS" "纯文字同步完成"; else log "ERROR" "纯文字同步失败"; fi
    else 
        log "SKIP" "内容重复，已跳过"
    fi 

else
    log "WARN" "未匹配到支持的同步类型，跳过。"
fi

log "INFO" "--- 流程结束 ---"
