#!/bin/bash

# =============================================================================
# lsi v5.0 - The Ultimate LS + Image Preview
# =============================================================================

# --- 配置区 ---
DEFAULT_GRID=5          # 网格模式：一行显示几张
TERM_PROTOCOL="k"       # k = Kitty (推荐), i = iTerm2, s = Sixel

# --- 帮助信息 ---
show_help() {
    echo "Usage: lsi [OPTIONS] [FILE/DIR...]"
    echo ""
    echo "Options:"
    echo "  -g, --grid N    Set grid size (default: $DEFAULT_GRID)"
    echo "  -h, --help      Show help"
    echo ""
    echo "Examples:"
    echo "  lsi                   # 当前目录网格预览"
    echo "  lsi image.jpg         # 单张高清预览"
    echo "  lsi -la ~/Pics        # 查看其他目录"
}

# --- 1. 参数解析 ---
EZA_ARGS=()
TARGET_FILES=()
GRID_SIZE=$DEFAULT_GRID

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        -g|--grid)
            if [[ -n "$2" && "$2" =~ ^[0-9]+$ ]]; then
                GRID_SIZE="$2"
                shift 2
            else
                echo "Error: --grid requires a number."
                exit 1
            fi
            ;;
        -*)
            # 透传参数给 eza (如 -l, -a, --tree)
            EZA_ARGS+=("$1")
            shift
            ;;
        *)
            # 文件或目录路径
            TARGET_FILES+=("$1")
            shift
            ;;
    esac
done

# 默认为当前目录
if [ ${#TARGET_FILES[@]} -eq 0 ]; then
    TARGET_FILES=(".")
fi

# --- 2. 运行 Eza (列表) ---
eza --icons "${EZA_ARGS[@]}" "${TARGET_FILES[@]}"

# --- 3. 智能图片收集逻辑 ---
IMAGES_TO_SHOW=()
MODE="GRID" 

# 判断是单文件还是目录
if [ ${#TARGET_FILES[@]} -eq 1 ]; then
    TARGET="${TARGET_FILES[0]}"
    if [ -f "$TARGET" ] && [[ "$TARGET" =~ \.(jpg|jpeg|png|gif|webp|bmp|svg)$ ]]; then
        IMAGES_TO_SHOW+=("$TARGET")
        MODE="SINGLE" # 只有这里切换为单图模式
    elif [ -d "$TARGET" ]; then
        shopt -s nullglob
        IMAGES_TO_SHOW=("${TARGET}"/*.{jpg,jpeg,png,gif,webp,bmp,svg})
        shopt -u nullglob
    fi
else
    # 混合参数情况 (lsi a.jpg b.jpg)
    for f in "${TARGET_FILES[@]}"; do
        if [[ -f "$f" && "$f" =~ \.(jpg|jpeg|png|gif|webp|bmp|svg)$ ]]; then
            IMAGES_TO_SHOW+=("$f")
        fi
    done
fi

# --- 4. 调用 timg 绘图 ---
if [ ${#IMAGES_TO_SHOW[@]} -gt 0 ]; then
    echo "" 
    
    if [ "$MODE" == "SINGLE" ]; then
        # === 单图模式 ===
        # 高清、全宽、显示完整标题
        timg -p "$TERM_PROTOCOL" -W --center --title="%f" "${IMAGES_TO_SHOW[0]}"
    else
        # === 网格模式 ===
        # 恢复了 --title="%b" (只显示文件名)
        echo -e "\033[0;36m--- 󰋩 Gallery Preview (${#IMAGES_TO_SHOW[@]} images) ---\033[0m"
        timg -p "$TERM_PROTOCOL" \
             --grid="$GRID_SIZE" \
             -W \
             --center \
             --upscale=i \
             --title="%b" \
             "${IMAGES_TO_SHOW[@]}"
    fi
fi
